name: Project Kanban Automation

on:
  issues:
    types: [assigned, unassigned]
  pull_request:
    types: [opened, reopened, closed]

env:
  PROJECT_NUMBER: 3
  PROJECT_OWNER: QuangNguyenNgoc
  PROJECT_OWNER_TYPE: user  # 'user' ho·∫∑c 'organization'

jobs:
  # ============================================
  # Job 1: Issue ƒë∆∞·ª£c assign ‚Üí Move to "In Progress"
  # ============================================
  move-to-in-progress:
    name: Move to In Progress
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'assigned'
    steps:
      - name: Get Project Item ID
        id: get-item
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          # Query ƒë·ªÉ l·∫•y Item ID c·ªßa issue trong project
          ITEM_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!, $issueNumber: Int!, $repo: String!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  id
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue {
                          number
                          repository {
                            name
                          }
                        }
                      }
                    }
                  }
                  field(name: "Status") {
                    ... on ProjectV2SingleSelectField {
                      id
                      options {
                        id
                        name
                      }
                    }
                  }
                }
              }
            }
          ' -f owner="${{ env.PROJECT_OWNER }}" -F number=${{ env.PROJECT_NUMBER }} -F issueNumber=${{ github.event.issue.number }} -f repo="${{ github.event.repository.name }}" --jq '.data.user.projectV2.items.nodes[] | select(.content.number == ${{ github.event.issue.number }} and .content.repository.name == "${{ github.event.repository.name }}") | .id')
          
          PROJECT_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  id
                }
              }
            }
          ' -f owner="${{ env.PROJECT_OWNER }}" -F number=${{ env.PROJECT_NUMBER }} --jq '.data.user.projectV2.id')
          
          FIELD_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  field(name: "Status") {
                    ... on ProjectV2SingleSelectField {
                      id
                    }
                  }
                }
              }
            }
          ' -f owner="${{ env.PROJECT_OWNER }}" -F number=${{ env.PROJECT_NUMBER }} --jq '.data.user.projectV2.field.id')
          
          OPTION_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  field(name: "Status") {
                    ... on ProjectV2SingleSelectField {
                      options {
                        id
                        name
                      }
                    }
                  }
                }
              }
            }
          ' -f owner="${{ env.PROJECT_OWNER }}" -F number=${{ env.PROJECT_NUMBER }} --jq '.data.user.projectV2.field.options[] | select(.name == "In Progress") | .id')
          
          echo "item_id=$ITEM_ID" >> $GITHUB_OUTPUT
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "field_id=$FIELD_ID" >> $GITHUB_OUTPUT
          echo "option_id=$OPTION_ID" >> $GITHUB_OUTPUT

      - name: Move to In Progress
        if: steps.get-item.outputs.item_id != ''
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $projectId
                itemId: $itemId
                fieldId: $fieldId
                value: { singleSelectOptionId: $optionId }
              }) {
                projectV2Item {
                  id
                }
              }
            }
          ' -f projectId="${{ steps.get-item.outputs.project_id }}" \
            -f itemId="${{ steps.get-item.outputs.item_id }}" \
            -f fieldId="${{ steps.get-item.outputs.field_id }}" \
            -f optionId="${{ steps.get-item.outputs.option_id }}"
          
          echo "‚úÖ Moved issue #${{ github.event.issue.number }} to In Progress"

  # ============================================
  # Job 2: PR ƒë∆∞·ª£c t·∫°o/reopened ‚Üí Move linked issue to "In Review"
  # ============================================
  move-to-in-review:
    name: Move to In Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'reopened')
    steps:
      - name: Extract Issue Number from PR
        id: extract-issue
        run: |
          # L·∫•y issue number t·ª´ branch name (format: type/issue-123-description)
          BRANCH="${{ github.head_ref }}"
          ISSUE_NUM=$(echo "$BRANCH" | grep -oP 'issue-\K\d+' || echo "")
          
          # N·∫øu kh√¥ng t√¨m th·∫•y trong branch, t√¨m trong PR body
          if [ -z "$ISSUE_NUM" ]; then
            BODY="${{ github.event.pull_request.body }}"
            ISSUE_NUM=$(echo "$BODY" | grep -oP '(?:fixes|closes|resolves)\s*#\K\d+' -i | head -1 || echo "")
          fi
          
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "üìå Found linked issue: #$ISSUE_NUM"

      - name: Move Issue to In Review
        if: steps.extract-issue.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
          ISSUE_NUM: ${{ steps.extract-issue.outputs.issue_number }}
        run: |
          # Get Item ID for the linked issue
          ITEM_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue {
                          number
                          repository {
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          ' -f owner="${{ env.PROJECT_OWNER }}" -F number=${{ env.PROJECT_NUMBER }} --jq ".data.user.projectV2.items.nodes[] | select(.content.number == $ISSUE_NUM and .content.repository.name == \"${{ github.event.repository.name }}\") | .id")
          
          if [ -z "$ITEM_ID" ]; then
            echo "‚ö†Ô∏è Issue #$ISSUE_NUM not found in project"
            exit 0
          fi
          
          PROJECT_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  id
                }
              }
            }
          ' -f owner="${{ env.PROJECT_OWNER }}" -F number=${{ env.PROJECT_NUMBER }} --jq '.data.user.projectV2.id')
          
          FIELD_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  field(name: "Status") {
                    ... on ProjectV2SingleSelectField {
                      id
                    }
                  }
                }
              }
            }
          ' -f owner="${{ env.PROJECT_OWNER }}" -F number=${{ env.PROJECT_NUMBER }} --jq '.data.user.projectV2.field.id')
          
          OPTION_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  field(name: "Status") {
                    ... on ProjectV2SingleSelectField {
                      options {
                        id
                        name
                      }
                    }
                  }
                }
              }
            }
          ' -f owner="${{ env.PROJECT_OWNER }}" -F number=${{ env.PROJECT_NUMBER }} --jq '.data.user.projectV2.field.options[] | select(.name == "In Review") | .id')
          
          # Update status
          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $projectId
                itemId: $itemId
                fieldId: $fieldId
                value: { singleSelectOptionId: $optionId }
              }) {
                projectV2Item {
                  id
                }
              }
            }
          ' -f projectId="$PROJECT_ID" -f itemId="$ITEM_ID" -f fieldId="$FIELD_ID" -f optionId="$OPTION_ID"
          
          echo "‚úÖ Moved issue #$ISSUE_NUM to In Review"

  # ============================================
  # Job 3: PR ƒë∆∞·ª£c merge ‚Üí Move linked issue to "Done"
  # ============================================
  move-to-done:
    name: Move to Done
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    steps:
      - name: Extract Issue Number from PR
        id: extract-issue
        run: |
          # L·∫•y issue number t·ª´ branch name
          BRANCH="${{ github.head_ref }}"
          ISSUE_NUM=$(echo "$BRANCH" | grep -oP 'issue-\K\d+' || echo "")
          
          # N·∫øu kh√¥ng t√¨m th·∫•y trong branch, t√¨m trong PR body
          if [ -z "$ISSUE_NUM" ]; then
            BODY="${{ github.event.pull_request.body }}"
            ISSUE_NUM=$(echo "$BODY" | grep -oP '(?:fixes|closes|resolves)\s*#\K\d+' -i | head -1 || echo "")
          fi
          
          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT

      - name: Move Issue to Done
        if: steps.extract-issue.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
          ISSUE_NUM: ${{ steps.extract-issue.outputs.issue_number }}
        run: |
          # Get Item ID
          ITEM_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue {
                          number
                          repository {
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          ' -f owner="${{ env.PROJECT_OWNER }}" -F number=${{ env.PROJECT_NUMBER }} --jq ".data.user.projectV2.items.nodes[] | select(.content.number == $ISSUE_NUM and .content.repository.name == \"${{ github.event.repository.name }}\") | .id")
          
          if [ -z "$ITEM_ID" ]; then
            echo "‚ö†Ô∏è Issue #$ISSUE_NUM not found in project"
            exit 0
          fi
          
          PROJECT_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  id
                }
              }
            }
          ' -f owner="${{ env.PROJECT_OWNER }}" -F number=${{ env.PROJECT_NUMBER }} --jq '.data.user.projectV2.id')
          
          FIELD_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  field(name: "Status") {
                    ... on ProjectV2SingleSelectField {
                      id
                    }
                  }
                }
              }
            }
          ' -f owner="${{ env.PROJECT_OWNER }}" -F number=${{ env.PROJECT_NUMBER }} --jq '.data.user.projectV2.field.id')
          
          OPTION_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  field(name: "Status") {
                    ... on ProjectV2SingleSelectField {
                      options {
                        id
                        name
                      }
                    }
                  }
                }
              }
            }
          ' -f owner="${{ env.PROJECT_OWNER }}" -F number=${{ env.PROJECT_NUMBER }} --jq '.data.user.projectV2.field.options[] | select(.name == "Done") | .id')
          
          # Update status
          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $projectId
                itemId: $itemId
                fieldId: $fieldId
                value: { singleSelectOptionId: $optionId }
              }) {
                projectV2Item {
                  id
                }
              }
            }
          ' -f projectId="$PROJECT_ID" -f itemId="$ITEM_ID" -f fieldId="$FIELD_ID" -f optionId="$OPTION_ID"
          
          echo "‚úÖ Moved issue #$ISSUE_NUM to Done"

  # ============================================
  # Job 4: Issue b·ªã unassign ‚Üí Move back to "Ready"
  # ============================================
  move-to-ready:
    name: Move back to Ready
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'unassigned'
    steps:
      - name: Check if issue has no assignees
        id: check-assignees
        run: |
          ASSIGNEES_COUNT=${{ github.event.issue.assignees && github.event.issue.assignees[0] && '1' || '0' }}
          echo "has_assignees=$ASSIGNEES_COUNT" >> $GITHUB_OUTPUT

      - name: Move to Ready
        if: steps.check-assignees.outputs.has_assignees == '0'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          ITEM_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue {
                          number
                          repository {
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          ' -f owner="${{ env.PROJECT_OWNER }}" -F number=${{ env.PROJECT_NUMBER }} --jq ".data.user.projectV2.items.nodes[] | select(.content.number == ${{ github.event.issue.number }} and .content.repository.name == \"${{ github.event.repository.name }}\") | .id")
          
          if [ -z "$ITEM_ID" ]; then
            echo "‚ö†Ô∏è Issue not found in project"
            exit 0
          fi
          
          PROJECT_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  id
                }
              }
            }
          ' -f owner="${{ env.PROJECT_OWNER }}" -F number=${{ env.PROJECT_NUMBER }} --jq '.data.user.projectV2.id')
          
          FIELD_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  field(name: "Status") {
                    ... on ProjectV2SingleSelectField {
                      id
                    }
                  }
                }
              }
            }
          ' -f owner="${{ env.PROJECT_OWNER }}" -F number=${{ env.PROJECT_NUMBER }} --jq '.data.user.projectV2.field.id')
          
          OPTION_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              user(login: $owner) {
                projectV2(number: $number) {
                  field(name: "Status") {
                    ... on ProjectV2SingleSelectField {
                      options {
                        id
                        name
                      }
                    }
                  }
                }
              }
            }
          ' -f owner="${{ env.PROJECT_OWNER }}" -F number=${{ env.PROJECT_NUMBER }} --jq '.data.user.projectV2.field.options[] | select(.name == "Ready") | .id')
          
          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $projectId
                itemId: $itemId
                fieldId: $fieldId
                value: { singleSelectOptionId: $optionId }
              }) {
                projectV2Item {
                  id
                }
              }
            }
          ' -f projectId="$PROJECT_ID" -f itemId="$ITEM_ID" -f fieldId="$FIELD_ID" -f optionId="$OPTION_ID"
          
          echo "‚úÖ Moved issue #${{ github.event.issue.number }} back to Ready"