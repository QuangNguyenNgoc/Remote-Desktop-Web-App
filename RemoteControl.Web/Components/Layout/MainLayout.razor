@inherits LayoutComponentBase
@using RemoteControl.Web.Services
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject TranslationService Lang

@if (_isChecking)
{
    <div class="flex h-screen items-center justify-center" style="background-color: var(--body-bg);">
        <div class="text-center">
            <div class="loading-spinner" style="width: 2rem; height: 2rem; border: 3px solid var(--card-border); border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 1rem;"></div>
            <p style="color: var(--text-tertiary);">Loading...</p>
        </div>
    </div>
}
else
{
    <div class="flex h-screen overflow-hidden font-sans" style="background-color: var(--sidebar-bg); color: var(--text-primary);">
        <Sidebar />

        <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
            <TopBar PageTitle="@PageTitle" />

            <div class="flex-1 overflow-auto p-6 relative" style="@GetWallpaperStyle()">
                @Body
            </div>
        </main>
    </div>
    
    @* Global toast notifications *@
    <RemoteControl.Web.Components.Shared.ToastContainer />
}

<style>
    @@keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>

@code {
    public static string PageTitle { get; set; } = "Dashboard";
    
    private bool _isChecking = true;
    private bool _initialized = false;
    private string _selectedWallpaper = "default";

    // Wallpaper gradients matching Settings.razor - increased opacity for visibility
    private static readonly Dictionary<string, string> WallpaperGradients = new()
    {
        { "default", "" },
        { "sunset", "linear-gradient(135deg, rgba(249, 115, 22, 0.25) 0%, rgba(236, 72, 153, 0.25) 100%)" },
        { "ocean", "linear-gradient(135deg, rgba(6, 182, 212, 0.25) 0%, rgba(59, 130, 246, 0.25) 100%)" },
        { "forest", "linear-gradient(135deg, rgba(34, 197, 94, 0.25) 0%, rgba(16, 185, 129, 0.25) 100%)" },
        { "purple", "linear-gradient(135deg, rgba(168, 85, 247, 0.25) 0%, rgba(139, 92, 246, 0.25) 100%)" },
        { "midnight", "linear-gradient(135deg, rgba(30, 41, 59, 0.5) 0%, rgba(15, 23, 42, 0.5) 100%)" }
    };

    private string GetWallpaperStyle()
    {
        if (_selectedWallpaper == "default" || !WallpaperGradients.TryGetValue(_selectedWallpaper, out var gradient) || string.IsNullOrEmpty(gradient))
        {
            return "background-color: var(--body-bg);";
        }
        return $"background: {gradient}, var(--body-bg);";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _initialized) return;
        _initialized = true;

        try
        {
            var isLoggedIn = await IsAuthenticatedAsync();
            
            if (!isLoggedIn)
            {
                Nav.NavigateTo("/login", forceLoad: true);
                return;
            }

            // Apply stored theme and wallpaper from settings
            await ApplyStoredTheme();
            await LoadWallpaper();
            await LoadStoredLanguage();

            _isChecking = false;
            StateHasChanged();
        }
        catch
        {
            // If JS fails, redirect to login
            Nav.NavigateTo("/login", forceLoad: true);
        }
    }

    private async Task LoadWallpaper()
    {
        try
        {
            var wallpaper = await JS.InvokeAsync<string?>("localStorage.getItem", "settings_wallpaper");
            if (!string.IsNullOrEmpty(wallpaper) && WallpaperGradients.ContainsKey(wallpaper))
            {
                _selectedWallpaper = wallpaper;
            }
        }
        catch
        {
            // Ignore errors
        }
    }

    private async Task LoadStoredLanguage()
    {
        try
        {
            var language = await JS.InvokeAsync<string?>("localStorage.getItem", "settings_language");
            if (!string.IsNullOrEmpty(language))
            {
                Lang.SetLanguage(language);
            }
        }
        catch
        {
            // Ignore errors
        }
    }

    private async Task ApplyStoredTheme()
    {
        try
        {
            var isDarkMode = await JS.InvokeAsync<string?>("localStorage.getItem", "settings_darkMode") == "true";
            if (isDarkMode)
            {
                await JS.InvokeVoidAsync("eval", "document.documentElement.classList.add('dark'); document.documentElement.classList.remove('light');");
            }
            else
            {
                await JS.InvokeVoidAsync("eval", "document.documentElement.classList.remove('dark'); document.documentElement.classList.add('light');");
            }
        }
        catch
        {
            // Ignore theme errors
        }
    }

    // Check authentication with session storage and localStorage TTL
    private async Task<bool> IsAuthenticatedAsync()
    {
        // Check session storage first (not remembered, valid for browser session)
        var session = await JS.InvokeAsync<string>("sessionStorage.getItem", "rc_auth_session");
        if (session == "1") return true;

        // Check localStorage with TTL (remembered, valid for 7 days)
        var flag = await JS.InvokeAsync<string>("localStorage.getItem", "rc_auth");
        var untilStr = await JS.InvokeAsync<string>("localStorage.getItem", "rc_auth_until");
        if (flag != "1" || string.IsNullOrWhiteSpace(untilStr)) return false;

        if (!long.TryParse(untilStr, out var until)) return false;
        var now = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
        return now <= until;
    }
}