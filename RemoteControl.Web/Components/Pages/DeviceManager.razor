@page "/devices"
@using Microsoft.AspNetCore.SignalR.Client
@using RemoteControl.Shared.Models
@using RemoteControl.Shared.Constants
@implements IAsyncDisposable
@inject NavigationManager Nav
@inject IJSRuntime JS

<SearchInput />

@if (_isLoading)
{
    <div class="flex justify-center items-center py-12">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2" style="border-color: var(--btn-primary-bg);"></div>
        <span class="ml-3" style="color: var(--text-secondary);">Đang tải danh sách agents...</span>
    </div>
}
else if (_agents.Count == 0)
{
    <div class="text-center py-12 rounded-xl" style="background-color: var(--card-bg); border: 1px solid var(--card-border);">
        <svg class="w-16 h-16 mx-auto mb-4" style="color: var(--text-quaternary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
        </svg>
        <h3 class="text-lg font-semibold mb-2" style="color: var(--text-primary);">Chưa có Agent nào kết nối</h3>
        <p class="text-sm" style="color: var(--text-secondary);">
            Chạy RemoteControl.Agent trên máy cần điều khiển để bắt đầu.
        </p>
    </div>
}
else
{
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        @foreach (var agent in _agents)
        {
            <DeviceCard Name="@agent.MachineName"
                        Ip="@agent.IpAddress"
                        OS="@agent.OsVersion"
                        IsOnline="@(agent.Status == AgentStatus.Online)"
                        LastSeen="@FormatLastSeen(agent.LastSeen)"
                        OnConnect="() => Connect(agent.AgentId)" />
        }
    </div>
}

@code {
    private HubConnection? _hubConnection;
    private List<AgentInfo> _agents = new();
    private bool _isLoading = true;

    private bool _initialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _initialized) return;
        _initialized = true;

        // ✅ JS interop chỉ gọi sau render (tránh lỗi prerender)
        var authed = await JS.InvokeAsync<bool>("passkeyAuth.me");
        if (!authed)
        {
            var returnUrl = new Uri(Nav.Uri).PathAndQuery;
            Nav.NavigateTo($"/login?returnUrl={Uri.EscapeDataString(returnUrl)}", forceLoad: true);
            return;
        }

        // ✅ Quan trọng: HubConnection ở Web chạy server-side -> phải tự gắn header X-Passkey
        var passkey = await JS.InvokeAsync<string>("passkeyAuth.getPasskey");

        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri("/remotehub"), options =>
            {
                if (!string.IsNullOrWhiteSpace(passkey))
                    options.Headers["X-Passkey"] = passkey;
            })
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<AgentInfo>(HubEvents.AgentConnected, OnAgentConnected);
        _hubConnection.On<string>(HubEvents.AgentDisconnected, OnAgentDisconnected);

        try
        {
            await _hubConnection.StartAsync();
            _agents = await _hubConnection.InvokeAsync<List<AgentInfo>>(HubEvents.GetAllAgents);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SignalR connection error: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void OnAgentConnected(AgentInfo agent)
    {
        _agents.RemoveAll(a => a.AgentId == agent.AgentId);
        _agents.Insert(0, agent);
        InvokeAsync(StateHasChanged);
    }

    private void OnAgentDisconnected(string agentId)
    {
        var agent = _agents.FirstOrDefault(a => a.AgentId == agentId);
        if (agent != null)
        {
            _agents.Remove(agent);
            InvokeAsync(StateHasChanged);
        }
    }

    private string FormatLastSeen(DateTime? lastSeen)
    {
        if (lastSeen == null) return "Unknown";
        var diff = DateTime.UtcNow - lastSeen.Value;
        if (diff.TotalMinutes < 1) return "Now";
        if (diff.TotalHours < 1) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalDays < 1) return $"{(int)diff.TotalHours}h ago";
        return $"{(int)diff.TotalDays}d ago";
    }

    void Connect(string agentId)
    {
        Nav.NavigateTo($"/devices/{agentId}");
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
