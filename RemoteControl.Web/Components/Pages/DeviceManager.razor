@page "/devices"
@inject NavigationManager Nav
@using Microsoft.AspNetCore.SignalR.Client
@using RemoteControl.Shared.Models
@using RemoteControl.Shared.Constants
@implements IAsyncDisposable

<SearchInput />

@if (_isLoading)
{
    <div class="flex justify-center items-center h-64">
        <div class="text-gray-400">Loading agents...</div>
    </div>
}
else if (_agents.Count == 0)
{
    <div class="flex flex-col justify-center items-center h-64 text-gray-400">
        <div class="text-xl mb-2">No agents connected</div>
        <div class="text-sm">Start an agent to see it here</div>
    </div>
}
else
{
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        @foreach (var agent in _agents)
        {
            <DeviceCard Name="@agent.MachineName"
                        Ip="@agent.IpAddress"
                        OS="@agent.OsVersion"
                        IsOnline="@(agent.Status == AgentStatus.Online)"
                        LastSeen="@FormatLastSeen(agent.LastSeen)"
                        OnConnect="() => Connect(agent.AgentId)" />
        }
    </div>
}



@code {
    private HubConnection? _hubConnection;
    private List<AgentInfo> _agents = new();
    private bool _isLoading = true;
    private bool _isConnected => _hubConnection?.State == HubConnectionState.Connected;

    protected override async Task OnInitializedAsync()
    {
        // Create SignalR connection
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri("/remotehub"))
            .WithAutomaticReconnect()
            .Build();

        // Subscribe to agent events
        _hubConnection.On<AgentInfo>(HubEvents.AgentConnected, OnAgentConnected);
        _hubConnection.On<string>(HubEvents.AgentDisconnected, OnAgentDisconnected);

        try
        {
            await _hubConnection.StartAsync();
            
            // Fetch initial agent list
            _agents = await _hubConnection.InvokeAsync<List<AgentInfo>>(HubEvents.GetAllAgents);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SignalR connection error: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OnAgentConnected(AgentInfo agent)
    {
        // Remove existing if reconnecting
        _agents.RemoveAll(a => a.AgentId == agent.AgentId);
        _agents.Insert(0, agent);
        InvokeAsync(StateHasChanged);
    }

    private void OnAgentDisconnected(string agentId)
    {
        var agent = _agents.FirstOrDefault(a => a.AgentId == agentId);
        if (agent != null)
        {
            _agents.Remove(agent);
            InvokeAsync(StateHasChanged);
        }
    }

    private string FormatLastSeen(DateTime? lastSeen)
    {
        if (lastSeen == null) return "Unknown";
        var diff = DateTime.UtcNow - lastSeen.Value;
        if (diff.TotalMinutes < 1) return "Now";
        if (diff.TotalHours < 1) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalDays < 1) return $"{(int)diff.TotalHours}h ago";
        return $"{(int)diff.TotalDays}d ago";
    }

    void Connect(string agentId)
    {
        Nav.NavigateTo($"/devices/{agentId}");
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}