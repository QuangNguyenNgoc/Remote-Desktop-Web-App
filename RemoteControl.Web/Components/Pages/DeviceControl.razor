@page "/devices/{Id}"

@using Microsoft.AspNetCore.SignalR.Client
@using RemoteControl.Shared.Models
@using RemoteControl.Shared.Constants
@using System.Text.Json
@inject NavigationManager Nav

@implements IAsyncDisposable

<div class="flex flex-col gap-4 h-full">
    <!-- Header: th√¥ng tin thi·∫øt b·ªã + n√∫t back n·∫øu c·∫ßn -->
    <DeviceHeader DeviceId="@Id" />

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 h-full">
        <!-- C·ªôt tr√°i: c√°c action + log -->
        <div class="xl:col-span-2 flex flex-col gap-4">
            <!-- Card ch·ª©a c√°c action ƒëi·ªÅu khi·ªÉn -->
            <div class="rounded-xl border border-slate-200/80 bg-white/60 dark:bg-slate-900/40 dark:border-slate-700/80 shadow-sm p-4 flex flex-col gap-5">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="font-semibold text-lg">Device Control</span>
                        <span class="text-xs px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500">
                            ID: @Id
                        </span>
                    </div>

                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full @(IsConnected ? "bg-emerald-500" : "bg-red-500")"></span>
                        <span class="text-xs text-slate-500">
                            @(IsConnected ? "Connected" : "Disconnected")
                        </span>

                        <button class="text-xs px-2 py-1 rounded border border-slate-300 text-slate-600 hover:bg-slate-100"
                                @onclick="GoBack">
                            ‚Üê Back
                        </button>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="text-sm text-red-500 bg-red-50 dark:bg-red-950/40 border border-red-200 dark:border-red-900 px-3 py-2 rounded">
                        @errorMessage
                    </div>
                }

                <!-- Screenshot Actions -->
                <section class="space-y-2">
                    <h3 class="font-semibold text-sm text-slate-700 dark:text-slate-200">
                        Screenshot Actions
                    </h3>

                    <div class="flex flex-wrap items-center gap-3">
                        <button class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium
                                       bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-60 disabled:cursor-not-allowed"
                                disabled="@(!IsConnected || isScreenshotBusy)"
                                @onclick="CaptureScreenshotAsync">
                            <span>üì∏</span>
                            <span>@(isScreenshotBusy ? "Capturing..." : "Capture Screenshot")</span>
                        </button>

                        <span class="text-xs text-slate-500">
                            G·ª≠i l·ªánh ch·ª•p m√†n h√¨nh ƒë·∫øn Agent, k·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü RemoteScreen.
                        </span>
                    </div>
                </section>

                <hr class="border-slate-200 dark:border-slate-700" />

                <!-- Process Management UI -->
                <section class="space-y-3">
                    <h3 class="font-semibold text-sm text-slate-700 dark:text-slate-200">
                        Process Management
                    </h3>

                    <div class="flex flex-wrap items-center gap-3">
                        <button class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium
                                       bg-slate-800 text-white hover:bg-slate-900 disabled:opacity-60 disabled:cursor-not-allowed"
                                disabled="@(!IsConnected || isProcessBusy)"
                                @onclick="ListProcessesAsync">
                            <span>üìã</span>
                            <span>@(isProcessBusy ? "Loading..." : "List Processes")</span>
                        </button>

                        <span class="text-xs text-slate-500">
                            L·∫•y danh s√°ch process hi·ªán t·∫°i t·ª´ Agent.
                        </span>
                    </div>

                    <!-- Input + button Start Process -->
                    <div class="flex flex-wrap items-center gap-3">
                        <input class="px-2 py-1 rounded border border-slate-300 text-sm w-48"
                               placeholder="Process name (e.g. notepad.exe)"
                               @bind="newProcessName" />

                        <button class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium
                                       bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60 disabled:cursor-not-allowed"
                                disabled="@(!IsConnected || isProcessBusy || string.IsNullOrWhiteSpace(newProcessName))"
                                @onclick="StartProcessAsync">
                            ‚ñ∂ Start Process
                        </button>
                    </div>

                    <!-- Input + button Kill Process (PID) -->
                    <div class="flex flex-wrap items-center gap-3">
                        <input class="px-2 py-1 rounded border border-slate-300 text-sm w-32"
                               type="number"
                               placeholder="PID"
                               @bind="killProcessPidString" />

                        <button class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium
                                       bg-red-600 text-white hover:bg-red-700 disabled:opacity-60 disabled:cursor-not-allowed"
                                disabled="@(!IsConnected || isProcessBusy || string.IsNullOrWhiteSpace(killProcessPidString))"
                                @onclick="KillProcessAsync">
                            ‚úñ Kill Process
                        </button>

                        <span class="text-xs text-slate-500">
                            (T·∫°m th·ªùi nh·∫≠p PID th·ªß c√¥ng ‚Äì sau c√≥ th·ªÉ click t·ª´ b·∫£ng Process List)
                        </span>
                    </div>
                </section>

                <hr class="border-slate-200 dark:border-slate-700" />

                <!-- System Info -->
                <section class="space-y-3">
                    <h3 class="font-semibold text-sm text-slate-700 dark:text-slate-200">
                        System Info
                    </h3>

                    <div class="flex flex-wrap items-center gap-3">
                        <button class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium
                                       bg-sky-600 text-white hover:bg-sky-700 disabled:opacity-60 disabled:cursor-not-allowed"
                                disabled="@(!IsConnected || isSystemInfoBusy)"
                                @onclick="RefreshSystemInfoAsync">
                            üîÑ Refresh Info
                        </button>

                        <span class="text-xs text-slate-500">
                            Hi·ªÉn th·ªã CPU/RAM usage c·ªßa Agent, t·ª± ƒë·ªông update khi nh·∫≠n event <code>SystemInfoUpdated</code>.
                        </span>
                    </div>

                    @if (latestSystemInfoJson is not null)
                    {
                        <pre class="mt-1 text-xs bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 rounded px-3 py-2 overflow-x-auto">
@latestSystemInfoJson
                        </pre>
                    }
                    else
                    {
                        <div class="text-xs text-slate-400">
                            Ch∆∞a c√≥ system info n√†o ‚Äì b·∫•m "Refresh Info" ƒë·ªÉ l·∫•y l·∫ßn ƒë·∫ßu.
                        </div>
                    }
                </section>

                <!-- Loading state chung -->
                @if (isScreenshotBusy || isProcessBusy || isSystemInfoBusy)
                {
                    <div class="pt-2 flex items-center gap-2 text-xs text-slate-500">
                        <span class="inline-block w-3 h-3 rounded-full border-2 border-slate-300 border-t-slate-500 animate-spin"></span>
                        <span>ƒêang x·ª≠ l√Ω command...</span>
                    </div>
                }
            </div>

            <!-- Terminal Log -->
            <TerminalLog DeviceId="@Id" />
        </div>

        <!-- C·ªôt ph·∫£i: Remote Screen ho·∫∑c c√°c card kh√°c -->
        <div class="xl:col-span-1 flex flex-col gap-4">
            <RemoteScreen DeviceId="@Id"
                          ScreenshotBase64="@lastScreenshotBase64"
                          IsLoading="@isScreenshotBusy" />
        </div>
    </div>
</div>

@code {
    // Route parameter
    [Parameter]
    public string Id { get; set; } = default!;

    // K·∫øt n·ªëi SignalR
    private HubConnection? hubConnection;

    private bool IsConnected => hubConnection?.State == HubConnectionState.Connected;

    // Loading states
    private bool isScreenshotBusy;
    private bool isProcessBusy;
    private bool isSystemInfoBusy;

    // Error message
    private string? errorMessage;

    // Input cho Process
    private string? newProcessName;
    private string? killProcessPidString;

    // System info (JSON th√¥)
    private string? latestSystemInfoJson;

    // Screenshot m·ªõi nh·∫•t (base64) ƒë·ªÉ truy·ªÅn xu·ªëng RemoteScreen
    private string? lastScreenshotBase64;

    protected override async Task OnInitializedAsync()
    {
        // ƒê√∫ng endpoint ƒë√£ map trong Program.cs
        var hubUrl = Nav.ToAbsoluteUri("/remotehub").ToString();

        hubConnection = new HubConnectionBuilder()
            .WithUrl(hubUrl)
            .WithAutomaticReconnect()
            .Build();

        // Nh·∫≠n k·∫øt qu·∫£ command t·ª´ hub (CommandResult)
        hubConnection.On<JsonElement>(HubEvents.CommandCompleted, payload =>
        {
            try
            {
                Console.WriteLine($"[DeviceControl] CommandCompleted: {payload}");

                // Ch·ªâ quan t√¢m k·∫øt qu·∫£ c·ªßa ƒë√∫ng Agent hi·ªán t·∫°i
                if (!payload.TryGetProperty("agentId", out var agentIdProp))
                    return;

                var agentId = agentIdProp.GetString();
                if (!string.Equals(agentId, Id, StringComparison.OrdinalIgnoreCase))
                    return;

                // L·∫•y ph·∫ßn Data
                if (!payload.TryGetProperty("data", out var dataElement))
                    return;
                if (dataElement.ValueKind != JsonValueKind.Object)
                    return;

                // Ki·ªÉm tra xem c√≥ ph·∫£i ScreenshotResult hay kh√¥ng
                JsonElement imgProp;
                if (!(dataElement.TryGetProperty("imageBase64", out imgProp) ||
                      dataElement.TryGetProperty("ImageBase64", out imgProp)))
                {
                    // Kh√¥ng ph·∫£i screenshot ‚Üí b·ªè qua (c√≥ th·ªÉ l√† k·∫øt qu·∫£ Process, Registry, ...)
                    return;
                }

                lastScreenshotBase64 = imgProp.GetString();
                InvokeStateHasChangedSafe();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[DeviceControl] Error handling CommandCompleted: {ex}");
            }
        });

        // Nh·∫≠n system info update
        hubConnection.On<JsonElement>(HubEvents.SystemInfoUpdated, payload =>
        {
            latestSystemInfoJson = JsonSerializer.Serialize(
                payload,
                new JsonSerializerOptions { WriteIndented = true });

            InvokeStateHasChangedSafe();
        });

        try
        {
            await hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi Hub: {ex.Message}";
        }
    }

    // G·ª≠i command chung
    private async Task SendCommandAsync(CommandRequest request, string scope)
    {
        if (hubConnection is null)
        {
            errorMessage = "Hub connection ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o.";
            return;
        }

        if (hubConnection.State != HubConnectionState.Connected)
        {
            errorMessage = "Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c t·ªõi Hub.";
            return;
        }

        SetBusy(scope, true);
        errorMessage = null;

        // Render ngay ƒë·ªÉ th·∫•y n√∫t ƒë·ªïi text / spinner
        InvokeStateHasChangedSafe();

        try
        {
            await hubConnection.InvokeAsync(HubEvents.SendCommand, request);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            SetBusy(scope, false);
            InvokeStateHasChangedSafe();
        }
    }

    private void SetBusy(string scope, bool value)
    {
        switch (scope)
        {
            case "screenshot":
                isScreenshotBusy = value;
                break;
            case "process":
                isProcessBusy = value;
                break;
            case "system":
                isSystemInfoBusy = value;
                break;
        }
    }

    // === C√°c handler cho n√∫t b·∫•m ===

    // 1) Screenshot
    private async Task CaptureScreenshotAsync()
    {
        var req = CommandRequest.CreateCaptureScreen(Id);
        await SendCommandAsync(req, "screenshot");
    }

    // 2) List processes
    private async Task ListProcessesAsync()
    {
        var req = CommandRequest.CreateListProcesses(Id);
        await SendCommandAsync(req, "process");
    }

    // 3) Kill process theo PID nh·∫≠p tay
    private async Task KillProcessAsync()
    {
        if (!int.TryParse(killProcessPidString, out var pid))
            return;

        var req = CommandRequest.CreateKillProcess(Id, pid);
        await SendCommandAsync(req, "process");
    }

    // 4) Start process theo t√™n
    private async Task StartProcessAsync()
    {
        if (string.IsNullOrWhiteSpace(newProcessName))
            return;

        var req = CommandRequest.CreateStartProcess(Id, newProcessName);
        await SendCommandAsync(req, "process");
        newProcessName = string.Empty;
    }

    // 5) Refresh system info
    private async Task RefreshSystemInfoAsync()
    {
        var req = CommandRequest.CreateGetSystemInfo(Id);
        await SendCommandAsync(req, "system");
    }

    // ƒêi·ªÅu h∆∞·ªõng quay l·∫°i danh s√°ch
    private void GoBack()
    {
        Nav.NavigateTo("/devices");
    }

    private void InvokeStateHasChangedSafe()
    {
        try
        {
            InvokeAsync(StateHasChanged);
        }
        catch
        {
            // ignore
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
