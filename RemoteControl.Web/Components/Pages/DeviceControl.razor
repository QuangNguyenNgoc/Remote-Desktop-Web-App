@page "/devices/{Id}"

@using Microsoft.AspNetCore.SignalR.Client
@using RemoteControl.Shared.Models
@using RemoteControl.Shared.Constants
@using System.Text.Json
@using System.Linq
@inject NavigationManager Nav

@implements IAsyncDisposable

<div class="flex flex-col gap-4 h-full">
    <!-- Header: th√¥ng tin thi·∫øt b·ªã + n√∫t back n·∫øu c·∫ßn -->
    <DeviceHeader DeviceId="@Id" />

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 h-full">
        <!-- C·ªôt tr√°i: c√°c action + log -->
        <div class="xl:col-span-2 flex flex-col gap-4">
            <!-- Card ch·ª©a c√°c action ƒëi·ªÅu khi·ªÉn -->
            <div class="rounded-xl border border-slate-200/80 bg-white/60 dark:bg-slate-900/40 dark:border-slate-700/80 shadow-sm p-4 flex flex-col gap-5">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="font-semibold text-lg">Device Control</span>
                        <span class="text-xs px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500">
                            ID: @Id
                        </span>
                    </div>

                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full @(IsConnected ? "bg-emerald-500" : "bg-red-500")"></span>
                        <span class="text-xs text-slate-500">
                            @(IsConnected ? "Connected" : "Disconnected")
                        </span>

                        <button class="text-xs px-2 py-1 rounded border border-slate-300 text-slate-600 hover:bg-slate-100"
                                @onclick="GoBack">
                            ‚Üê Back
                        </button>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="text-sm text-red-500 bg-red-50 dark:bg-red-950/40 border border-red-200 dark:border-red-900 px-3 py-2 rounded">
                        @errorMessage
                    </div>
                }

                <!-- Screenshot Actions -->
                <section class="space-y-2">
                    <h3 class="font-semibold text-sm text-slate-700 dark:text-slate-200">
                        Screenshot Actions
                    </h3>

                    <div class="flex flex-wrap items-center gap-3">
                        <button class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium
                                       bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-60 disabled:cursor-not-allowed"
                                disabled="@(!IsConnected || isScreenshotBusy)"
                                @onclick="CaptureScreenshotAsync">
                            <span>üì∏</span>
                            <span>@(isScreenshotBusy ? "Capturing..." : "Capture Screenshot")</span>
                        </button>

                        <span class="text-xs text-slate-500">
                            G·ª≠i l·ªánh ch·ª•p m√†n h√¨nh ƒë·∫øn Agent, k·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü RemoteScreen.
                        </span>
                    </div>
                </section>

                <hr class="border-slate-200 dark:border-slate-700" />

                <!-- Process Management UI -->
                <section class="space-y-3">
                    <h3 class="font-semibold text-sm text-slate-700 dark:text-slate-200">
                        Process Management
                    </h3>

                    <div class="flex flex-wrap items-center gap-3">
                        <button class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium
                                       bg-slate-800 text-white hover:bg-slate-900 disabled:opacity-60 disabled:cursor-not-allowed"
                                disabled="@(!IsConnected || isProcessBusy)"
                                @onclick="ListProcessesAsync">
                            <span>üìã</span>
                            <span>@(isProcessBusy ? "Loading..." : "List Processes")</span>
                        </button>

                        <span class="text-xs text-slate-500">
                            L·∫•y danh s√°ch process hi·ªán t·∫°i t·ª´ Agent.
                        </span>
                    </div>

                    <!-- Input + button Start Process -->
                    <div class="flex flex-wrap items-center gap-3">
                        <input class="px-2 py-1 rounded border border-slate-300 text-sm w-48"
                               placeholder="Process name (e.g. notepad.exe)"
                               @bind="newProcessName" />

                        <button class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium
                                       bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-60 disabled:cursor-not-allowed"
                                disabled="@(!IsConnected || isProcessBusy || string.IsNullOrWhiteSpace(newProcessName))"
                                @onclick="StartProcessAsync">
                            ‚ñ∂ Start Process
                        </button>
                    </div>

                    <!-- Input + button Kill Process (PID) -->
                    <div class="flex flex-wrap items-center gap-3">
                        <input class="px-2 py-1 rounded border border-slate-300 text-sm w-32"
                               type="number"
                               placeholder="PID"
                               @bind="killProcessPidString" />

                        <button class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium
                                       bg-red-600 text-white hover:bg-red-700 disabled:opacity-60 disabled:cursor-not-allowed"
                                disabled="@(!IsConnected || isProcessBusy || string.IsNullOrWhiteSpace(killProcessPidString))"
                                @onclick="KillProcessAsync">
                            ‚úñ Kill Process
                        </button>

                        <span class="text-xs text-slate-500">
                            (B·∫°n c√≥ th·ªÉ Kill theo t·ª´ng d√≤ng ·ªü b·∫£ng b√™n d∆∞·ªõi)
                        </span>
                    </div>

                    <!-- Process Table -->
                    @if (processList.Count > 0)
                    {
                        <div class="mt-2 overflow-x-auto border border-slate-200 dark:border-slate-700 rounded-lg">
                            <table class="min-w-full text-sm">
                                <thead class="bg-slate-50 dark:bg-slate-900/60">
                                    <tr class="text-left text-slate-600 dark:text-slate-200">
                                        <th class="px-3 py-2">PID</th>
                                        <th class="px-3 py-2">Name</th>
                                        <th class="px-3 py-2">Memory (MB)</th>
                                        <th class="px-3 py-2">CPU (%)</th>
                                        <th class="px-3 py-2">Threads</th>
                                        <th class="px-3 py-2">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var p in processList)
                                    {
                                        <tr class="border-t border-slate-200 dark:border-slate-700">
                                            <td class="px-3 py-2 text-slate-700 dark:text-slate-100">@p.ProcessId</td>
                                            <td class="px-3 py-2 text-slate-700 dark:text-slate-100">@p.ProcessName</td>
                                            <td class="px-3 py-2 text-slate-700 dark:text-slate-100">@p.MemoryUsageMB</td>
                                            <td class="px-3 py-2 text-slate-700 dark:text-slate-100">@p.CpuUsage</td>
                                            <td class="px-3 py-2 text-slate-700 dark:text-slate-100">@p.ThreadCount</td>
                                            <td class="px-3 py-2">
                                                <button class="inline-flex items-center gap-2 px-2 py-1 rounded text-xs font-medium
                                                               bg-red-600 text-white hover:bg-red-700 disabled:opacity-60 disabled:cursor-not-allowed"
                                                        disabled="@(!IsConnected || isProcessBusy)"
                                                        @onclick="() => KillProcessRowAsync(p.ProcessId, p.ProcessName)">
                                                    ‚úñ Kill
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-xs text-slate-400">
                            Ch∆∞a c√≥ danh s√°ch process ‚Äì b·∫•m "List Processes" ƒë·ªÉ l·∫•y.
                        </div>
                    }
                </section>

                <hr class="border-slate-200 dark:border-slate-700" />

                <!-- System Info -->
                <section class="space-y-3">
                    <h3 class="font-semibold text-sm text-slate-700 dark:text-slate-200">
                        System Info
                    </h3>

                    <div class="flex flex-wrap items-center gap-3">
                        <button class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium
                                       bg-sky-600 text-white hover:bg-sky-700 disabled:opacity-60 disabled:cursor-not-allowed"
                                disabled="@(!IsConnected || isSystemInfoBusy)"
                                @onclick="RefreshSystemInfoAsync">
                            üîÑ Refresh Info
                        </button>

                        <span class="text-xs text-slate-500">
                            Hi·ªÉn th·ªã CPU/RAM usage c·ªßa Agent, t·ª± ƒë·ªông update khi nh·∫≠n event <code>SystemInfoUpdated</code>.
                        </span>
                    </div>

                    @if (latestSystemInfoJson is not null)
                    {
                        <pre class="mt-1 text-xs bg-slate-50 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-700 rounded px-3 py-2 overflow-x-auto">
@latestSystemInfoJson
                        </pre>
                    }
                    else
                    {
                        <div class="text-xs text-slate-400">
                            Ch∆∞a c√≥ system info n√†o ‚Äì b·∫•m "Refresh Info" ƒë·ªÉ l·∫•y l·∫ßn ƒë·∫ßu.
                        </div>
                    }
                </section>

                <!-- Loading state chung -->
                @if (isScreenshotBusy || isProcessBusy || isSystemInfoBusy)
                {
                    <div class="pt-2 flex items-center gap-2 text-xs text-slate-500">
                        <span class="inline-block w-3 h-3 rounded-full border-2 border-slate-300 border-t-slate-500 animate-spin"></span>
                        <span>ƒêang ch·ªù response...</span>
                    </div>
                }
            </div>

            <!-- Terminal Log -->
            <TerminalLog DeviceId="@Id" />
        </div>

        <!-- C·ªôt ph·∫£i: Remote Screen ho·∫∑c c√°c card kh√°c -->
        <div class="xl:col-span-1 flex flex-col gap-4">
            <RemoteScreen DeviceId="@Id"
                          ScreenshotBase64="@lastScreenshotBase64"
                          IsLoading="@isScreenshotBusy" />
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string Id { get; set; } = default!;

    private HubConnection? hubConnection;
    private bool IsConnected => hubConnection?.State == HubConnectionState.Connected;

    // Loading states
    private bool isScreenshotBusy;
    private bool isProcessBusy;
    private bool isSystemInfoBusy;

    // Error message
    private string? errorMessage;

    // Inputs
    private string? newProcessName;
    private string? killProcessPidString;

    // System info (JSON)
    private string? latestSystemInfoJson;

    // Screenshot base64
    private string? lastScreenshotBase64;

    // Process list
    private readonly List<ProcessInfo> processList = new();

    // Pending commands: CommandId -> scope ("screenshot"/"process"/"system")
    private readonly Dictionary<string, string> pendingCommands = new(StringComparer.OrdinalIgnoreCase);

    private const string HubEvent_CommandFailed = "CommandFailed";

    protected override async Task OnInitializedAsync()
    {
        var hubUrl = Nav.ToAbsoluteUri("/remotehub").ToString();

        hubConnection = new HubConnectionBuilder()
            .WithUrl(hubUrl)
            .WithAutomaticReconnect()
            .Build();

        // =========================
        // CommandCompleted: x·ª≠ l√Ω Screenshot / Processes / SystemInfo
        // + Clear loading theo CommandId (ho·∫∑c fallback theo scope n·∫øu thi·∫øu CommandId)
        // =========================
        hubConnection.On<JsonElement>(HubEvents.CommandCompleted, payload =>
        {
            try
            {
                if (!TryGetPropertyIgnoreCase(payload, "agentId", out var agentIdProp))
                    return;

                var agentId = agentIdProp.GetString();
                if (!string.Equals(agentId, Id, StringComparison.OrdinalIgnoreCase))
                    return;

                string? commandId = null;
                if (TryGetPropertyIgnoreCase(payload, "commandId", out var cmdIdProp))
                    commandId = cmdIdProp.GetString();

                bool? success = null;
                if (TryGetPropertyIgnoreCase(payload, "success", out var successProp) &&
                    (successProp.ValueKind == JsonValueKind.True || successProp.ValueKind == JsonValueKind.False))
                    success = successProp.GetBoolean();

                string? message = null;
                if (TryGetPropertyIgnoreCase(payload, "message", out var msgProp))
                    message = msgProp.GetString();

                bool gotScreenshot = false;
                bool gotProcesses = false;
                bool gotSystemInfo = false;

                if (!TryGetPropertyIgnoreCase(payload, "data", out var dataElement))
                {
                    if (!string.IsNullOrWhiteSpace(commandId)) CompletePending(commandId!);
                    if (success == false && !string.IsNullOrWhiteSpace(message)) errorMessage = message;
                    InvokeStateHasChangedSafe();
                    return;
                }

                if (dataElement.ValueKind == JsonValueKind.Object)
                {
                    // 1) Screenshot
                    if (TryGetPropertyIgnoreCase(dataElement, "imageBase64", out var imgProp) &&
                        imgProp.ValueKind == JsonValueKind.String)
                    {
                        lastScreenshotBase64 = imgProp.GetString();
                        gotScreenshot = true;
                    }

                    // 2) Processes[]
                    if (TryGetPropertyIgnoreCase(dataElement, "processes", out var procsProp) &&
                        procsProp.ValueKind == JsonValueKind.Array)
                    {
                        var newList = ParseProcessList(procsProp);
                        processList.Clear();
                        processList.AddRange(newList);
                        gotProcesses = true;
                    }

                    // 3) SystemInfo (trong CommandCompleted)
                    if (TryParseSystemInfoFromObject(dataElement, out var sysInfoFromCmd))
                    {
                        latestSystemInfoJson = JsonSerializer.Serialize(sysInfoFromCmd,
                            new JsonSerializerOptions { WriteIndented = true });
                        gotSystemInfo = true;
                    }
                }

                // Clear busy ƒë√∫ng nghƒ©a ‚Äúch·ªù response‚Äù
                if (!string.IsNullOrWhiteSpace(commandId))
                {
                    CompletePending(commandId!);
                }
                else
                {
                    // Fallback: n·∫øu payload kh√¥ng c√≥ commandId, nh∆∞ng ƒë√£ nh·∫≠n ƒë∆∞·ª£c data,
                    // v·∫´n ph·∫£i t·∫Øt busy ƒë√∫ng scope ƒë·ªÉ kh·ªèi k·∫πt "Capturing..."
                    if (gotScreenshot) ClearPendingScope("screenshot");
                    if (gotProcesses) ClearPendingScope("process");
                    if (gotSystemInfo) ClearPendingScope("system");
                }

                if (success == false && !string.IsNullOrWhiteSpace(message))
                    errorMessage = message;

                InvokeStateHasChangedSafe();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[DeviceControl] Error handling CommandCompleted: {ex}");
            }
        });

        // =========================
        // CommandFailed: Agent offline / route fail
        // Server g·ª≠i: (CommandRequest request, string message)
        // =========================
        hubConnection.On<CommandRequest, string>(HubEvent_CommandFailed, (request, message) =>
        {
            try
            {
                if (!string.Equals(request.AgentId, Id, StringComparison.OrdinalIgnoreCase))
                    return;

                errorMessage = message;

                if (!string.IsNullOrWhiteSpace(request.CommandId))
                    CompletePending(request.CommandId);
                else
                    RecomputeBusyFromPending();

                InvokeStateHasChangedSafe();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[DeviceControl] Error handling CommandFailed: {ex}");
            }
        });

        // =========================
        // SystemInfoUpdated: chu·∫©n 2 params (agentId, systemInfo)
        // =========================
        hubConnection.On<string, SystemInfo>(HubEvents.SystemInfoUpdated, (agentId2, systemInfo) =>
        {
            try
            {
                if (!string.Equals(agentId2, Id, StringComparison.OrdinalIgnoreCase))
                    return;

                latestSystemInfoJson = JsonSerializer.Serialize(systemInfo,
                    new JsonSerializerOptions { WriteIndented = true });

                InvokeStateHasChangedSafe();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[DeviceControl] Error handling SystemInfoUpdated: {ex}");
            }
        });

        try
        {
            await hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi Hub: {ex.Message}";
        }
    }

    // Validate agent online tr∆∞·ªõc khi g·ª≠i command
    private async Task<bool> EnsureAgentOnlineAsync()
    {
        if (hubConnection is null || hubConnection.State != HubConnectionState.Connected)
            return false;

        try
        {
            var agents = await hubConnection.InvokeAsync<List<AgentInfo>>(HubEvents.GetAllAgents);
            var found = agents.FirstOrDefault(a => string.Equals(a.AgentId, Id, StringComparison.OrdinalIgnoreCase));

            if (found is null || found.Status != AgentStatus.Online)
            {
                errorMessage = $"Agent {Id} ƒëang offline";
                return false;
            }

            return true;
        }
        catch
        {
            // fallback: n·∫øu l·ªói call GetAllAgents, v·∫´n cho ph√©p g·ª≠i.
            // CommandFailed ph√≠a server s·∫Ω tr·∫£ n·∫øu offline.
            return true;
        }
    }

    // G·ª≠i command (gi·ªØ busy cho t·ªõi khi nh·∫≠n CommandCompleted/CommandFailed)
    private async Task SendCommandAsync(CommandRequest request, string scope)
    {
        if (hubConnection is null)
        {
            errorMessage = "Hub connection ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o.";
            return;
        }

        if (hubConnection.State != HubConnectionState.Connected)
        {
            errorMessage = "Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c t·ªõi Hub.";
            return;
        }

        errorMessage = null;

        if (!await EnsureAgentOnlineAsync())
        {
            InvokeStateHasChangedSafe();
            return;
        }

        MarkPending(request.CommandId, scope);
        InvokeStateHasChangedSafe();

        try
        {
            await hubConnection.InvokeAsync(HubEvents.SendCommand, request);
            // KH√îNG clear busy ·ªü ƒë√¢y (ƒë·ª£i response)
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            CompletePending(request.CommandId);
            InvokeStateHasChangedSafe();
        }
    }

    private void MarkPending(string commandId, string scope)
    {
        if (string.IsNullOrWhiteSpace(commandId)) return;
        pendingCommands[commandId] = scope;
        RecomputeBusyFromPending();
    }

    private void CompletePending(string commandId)
    {
        if (string.IsNullOrWhiteSpace(commandId)) return;
        pendingCommands.Remove(commandId);
        RecomputeBusyFromPending();
    }

    private void ClearPendingScope(string scope)
    {
        var toRemove = new List<string>();
        foreach (var kv in pendingCommands)
        {
            if (string.Equals(kv.Value, scope, StringComparison.OrdinalIgnoreCase))
                toRemove.Add(kv.Key);
        }

        foreach (var k in toRemove)
            pendingCommands.Remove(k);

        RecomputeBusyFromPending();
    }

    private void RecomputeBusyFromPending()
    {
        isScreenshotBusy = AnyPendingScope("screenshot");
        isProcessBusy = AnyPendingScope("process");
        isSystemInfoBusy = AnyPendingScope("system");
    }

    private bool AnyPendingScope(string scope)
    {
        foreach (var kv in pendingCommands)
        {
            if (string.Equals(kv.Value, scope, StringComparison.OrdinalIgnoreCase))
                return true;
        }
        return false;
    }

    // === Button handlers ===

    private async Task CaptureScreenshotAsync()
    {
        var req = CommandRequest.CreateCaptureScreen(Id);
        await SendCommandAsync(req, "screenshot");
    }

    private async Task ListProcessesAsync()
    {
        var req = CommandRequest.CreateListProcesses(Id);
        await SendCommandAsync(req, "process");
    }

    private async Task KillProcessAsync()
    {
        if (!int.TryParse(killProcessPidString, out var pid))
            return;

        var req = CommandRequest.CreateKillProcess(Id, pid);
        await SendCommandAsync(req, "process");
    }

    private async Task KillProcessRowAsync(int pid, string processName)
    {
        var req = CommandRequest.CreateKillProcess(Id, pid);
        req.ProcessName = processName; // th√™m name theo base model
        await SendCommandAsync(req, "process");
    }

    private async Task StartProcessAsync()
    {
        if (string.IsNullOrWhiteSpace(newProcessName))
            return;

        var req = CommandRequest.CreateStartProcess(Id, newProcessName);
        await SendCommandAsync(req, "process");
        newProcessName = string.Empty;
    }

    private async Task RefreshSystemInfoAsync()
    {
        var req = CommandRequest.CreateGetSystemInfo(Id);
        await SendCommandAsync(req, "system");
    }

    private void GoBack()
    {
        Nav.NavigateTo("/devices");
    }

    private void InvokeStateHasChangedSafe()
    {
        try { InvokeAsync(StateHasChanged); }
        catch { }
    }

    private static bool TryGetPropertyIgnoreCase(JsonElement obj, string name, out JsonElement value)
    {
        value = default;

        if (obj.ValueKind != JsonValueKind.Object)
            return false;

        if (obj.TryGetProperty(name, out value))
            return true;

        foreach (var p in obj.EnumerateObject())
        {
            if (string.Equals(p.Name, name, StringComparison.OrdinalIgnoreCase))
            {
                value = p.Value;
                return true;
            }
        }

        return false;
    }

    private static List<ProcessInfo> ParseProcessList(JsonElement arr)
    {
        var list = new List<ProcessInfo>();

        foreach (var item in arr.EnumerateArray())
        {
            if (item.ValueKind != JsonValueKind.Object)
                continue;

            var pi = new ProcessInfo();

            if (TryGetPropertyIgnoreCase(item, "processId", out var pidEl) && pidEl.TryGetInt32(out var pid))
                pi.ProcessId = pid;

            if (TryGetPropertyIgnoreCase(item, "processName", out var nameEl) && nameEl.ValueKind == JsonValueKind.String)
                pi.ProcessName = nameEl.GetString() ?? string.Empty;

            if (TryGetPropertyIgnoreCase(item, "threadCount", out var thEl) && thEl.TryGetInt32(out var th))
                pi.ThreadCount = th;

            if (TryGetPropertyIgnoreCase(item, "memoryUsageMB", out var memEl) && memEl.TryGetInt64(out var mem))
                pi.MemoryUsageMB = mem;

            if (TryGetPropertyIgnoreCase(item, "cpuUsage", out var cpuEl) && cpuEl.TryGetDouble(out var cpu))
                pi.CpuUsage = cpu;

            list.Add(pi);
        }

        list.Sort((a, b) => a.ProcessId.CompareTo(b.ProcessId));
        return list;
    }

    private static bool TryParseSystemInfoFromObject(JsonElement obj, out SystemInfo info)
    {
        info = new SystemInfo();

        if (obj.ValueKind != JsonValueKind.Object)
            return false;

        bool foundAny = false;

        if (TryGetPropertyIgnoreCase(obj, "cpuUsage", out var cpuEl) && cpuEl.TryGetDouble(out var cpu))
        {
            info.CpuUsage = cpu;
            foundAny = true;
        }

        if (TryGetPropertyIgnoreCase(obj, "memoryUsage", out var memEl) && memEl.TryGetDouble(out var mem))
        {
            info.MemoryUsage = mem;
            foundAny = true;
        }

        if (TryGetPropertyIgnoreCase(obj, "totalMemoryMB", out var totEl) && totEl.TryGetInt64(out var tot))
        {
            info.TotalMemoryMB = tot;
            foundAny = true;
        }

        if (TryGetPropertyIgnoreCase(obj, "processCount", out var pcEl) && pcEl.TryGetInt32(out var pc))
        {
            info.ProcessCount = pc;
            foundAny = true;
        }

        return foundAny;
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
