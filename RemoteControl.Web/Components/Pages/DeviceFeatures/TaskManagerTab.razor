@using RemoteControl.Shared.Models
@using RemoteControl.Shared.Constants
@using Microsoft.AspNetCore.SignalR.Client
@implements IAsyncDisposable
@inject NavigationManager Nav

@* Task Manager Tab Component *@
<div class="task-manager-container">
    <!-- Refresh Status Bar -->
    <div class="refresh-bar">
        <div class="refresh-status">
            @if (AutoRefreshEnabled)
            {
                <span class="status-dot active"></span>
                <span>Auto-refresh: ON (every 3s)</span>
            }
            else
            {
                <span class="status-dot"></span>
                <span>Auto-refresh: OFF</span>
            }
            <span class="last-refresh">Last: @LastRefreshTime.ToString("HH:mm:ss")</span>
        </div>
        <button class="toggle-btn @(AutoRefreshEnabled ? "active" : "")" @onclick="ToggleAutoRefresh">
            @if (AutoRefreshEnabled)
            {
                <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>Pause</span>
            }
            else
            {
                <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>Resume</span>
            }
        </button>
    </div>

    <!-- Run Process Section -->
    <div class="run-process-section">
        <div class="run-process-content">
            <h3 class="section-title">RUN PROCESS</h3>

            <div class="input-row">
                <!-- Process Name Input -->
                <div class="input-group">
                    <input type="text" @bind="ProcessName" placeholder="Process name (e.g., notepad.exe)"
                        class="process-input" />
                </div>

                <!-- Run Button -->
                <button @onclick="HandleRunProcess" class="run-button">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Run Process
                </button>
            </div>

            <!-- Quick Launch Buttons -->
            <div class="quick-launch">
                <span class="quick-label">Quick Launch:</span>
                <button @onclick="@(() => ProcessName = "notepad.exe")" class="quick-btn">Notepad</button>
                <button @onclick="@(() => ProcessName = "cmd.exe")" class="quick-btn">CMD</button>
                <button @onclick="@(() => ProcessName = "powershell.exe")" class="quick-btn">PowerShell</button>
                <button @onclick="@(() => ProcessName = "taskmgr.exe")" class="quick-btn">Task Manager</button>
            </div>
        </div>
    </div>

    <!-- Process Table -->
    <div class="task-manager-table-wrapper">
        <table class="task-table">
            <thead>
                <tr>
                    <th>PROCESS NAME</th>
                    <th>PID</th>
                    <th>CPU %</th>
                    <th>MEMORY</th>
                    <th class="text-center">ACTION</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var process in Processes)
                {
                    <tr>
                        <td class="font-semibold process-name">@process.ProcessName</td>
                        <td>@process.ProcessId</td>
                        <td>@process.CpuUsage.ToString("F1")%</td>
                        <td>@process.MemoryUsageMB MB</td>
                        <td class="cell-center">
                            <button class="kill-btn" @onclick="() => HandleKillProcess(process.ProcessId)">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Kill
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    // CascadingParameter from DeviceControl
    [CascadingParameter(Name = "AgentId")]
    public string AgentId { get; set; } = string.Empty;

    // SignalR
    private HubConnection? _hubConnection;
    private bool IsConnected => _hubConnection?.State == HubConnectionState.Connected;

    // UI State
    private string ProcessName { get; set; } = string.Empty;
    private bool AutoRefreshEnabled { get; set; } = true;
    private DateTime LastRefreshTime { get; set; } = DateTime.Now;
    private System.Timers.Timer? _refreshTimer;

    // Process data
    private List<ProcessInfo> Processes { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await InitializeSignalR();
        StartAutoRefresh();
        
        // Request initial process list
        if (IsConnected && !string.IsNullOrEmpty(AgentId))
        {
            await RequestProcessList();
        }
    }

    private async Task InitializeSignalR()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri("/remotehub"))
            .WithAutomaticReconnect()
            .Build();

        // Listen for command results
        _hubConnection.On<CommandResult>(HubEvents.CommandCompleted, OnCommandCompleted);

        try
        {
            await _hubConnection.StartAsync();
            Console.WriteLine("[TaskManager] SignalR connected");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[TaskManager] SignalR error: {ex.Message}");
        }
    }

    private void OnCommandCompleted(CommandResult result)
    {
        if (result.AgentId != AgentId) return;
        if (!result.Success) return;

        // ProcessListResult is stored in CommandResult.Data
        if (result.Data is System.Text.Json.JsonElement jsonElement)
        {
            try
            {
                var processResult = System.Text.Json.JsonSerializer.Deserialize<ProcessListResult>(
                    jsonElement.GetRawText(),
                    new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                
                if (processResult?.Processes != null)
                {
                    Processes = processResult.Processes;
                    LastRefreshTime = DateTime.Now;
                    InvokeAsync(StateHasChanged);
                    Console.WriteLine($"[TaskManager] Received {Processes.Count} processes");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[TaskManager] Parse error: {ex.Message}");
            }
        }
    }

    private async Task RequestProcessList()
    {
        if (_hubConnection == null || !IsConnected) return;
        
        var request = CommandRequest.CreateListProcesses(AgentId);
        await _hubConnection.InvokeAsync("SendCommand", request);
        Console.WriteLine($"[TaskManager] Requested process list for {AgentId}");
    }

    private void StartAutoRefresh()
    {
        _refreshTimer = new System.Timers.Timer(3000); // 3 seconds
        _refreshTimer.Elapsed += async (sender, e) => await RefreshProcessList();
        _refreshTimer.AutoReset = true;
        if (AutoRefreshEnabled)
        {
            _refreshTimer.Start();
        }
    }

    private async Task RefreshProcessList()
    {
        if (!AutoRefreshEnabled) return;

        // Request updated process list via SignalR
        await RequestProcessList();
    }

    private void ToggleAutoRefresh()
    {
        AutoRefreshEnabled = !AutoRefreshEnabled;
        if (AutoRefreshEnabled)
        {
            _refreshTimer?.Start();
        }
        else
        {
            _refreshTimer?.Stop();
        }
    }

    private async Task HandleRunProcess()
    {
        if (string.IsNullOrWhiteSpace(ProcessName)) return;
        if (_hubConnection == null || !IsConnected) return;

        var request = CommandRequest.CreateStartProcess(AgentId, ProcessName);
        await _hubConnection.InvokeAsync("SendCommand", request);
        Console.WriteLine($"[TaskManager] Running process: {ProcessName}");

        // Clear input after execution
        ProcessName = string.Empty;
        StateHasChanged();
    }

    private async Task HandleKillProcess(int processId)
    {
        if (_hubConnection == null || !IsConnected) return;

        var request = CommandRequest.CreateKillProcess(AgentId, processId);
        await _hubConnection.InvokeAsync("SendCommand", request);
        Console.WriteLine($"[TaskManager] Killing process: {processId}");

        // Optimistically remove from UI
        Processes = Processes.Where(p => p.ProcessId != processId).ToList();
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        _refreshTimer?.Stop();
        _refreshTimer?.Dispose();
        
        if (_hubConnection != null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}

<style>
    .task-manager-container {
        min-height: 400px;
        background-color: var(--table-bg);
        border-radius: 0 0 0.75rem 0.75rem;
        overflow: hidden;
    }

    /* Refresh Status Bar */
    .refresh-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1.5rem;
        background-color: var(--card-bg);
        border-bottom: 1px solid var(--card-border);
    }

    .refresh-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: var(--text-tertiary);
    }

    .status-dot {
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 50%;
        background-color: var(--text-tertiary);
    }

    .status-dot.active {
        background-color: #22c55e;
        animation: pulse 2s infinite;
    }

    .last-refresh {
        margin-left: 1rem;
        padding-left: 1rem;
        border-left: 1px solid var(--card-border);
    }

    .toggle-btn {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
        border-radius: 0.25rem;
        border: 1px solid var(--card-border);
        background-color: var(--table-bg);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s;
    }

    .toggle-btn:hover {
        background-color: var(--table-row-hover);
    }

    .toggle-btn.active {
        background-color: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.3);
        color: #ef4444;
    }

    .toggle-btn .btn-icon {
        width: 0.875rem;
        height: 0.875rem;
    }

    @@keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Run Process Section */
    .run-process-section {
        padding: 1.5rem;
        border-bottom: 1px solid var(--card-border);
        background-color: var(--card-bg);
    }

    .run-process-content {
        max-width: 56rem;
        margin: 0 auto;
    }

    .section-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-primary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 1rem;
    }

    .input-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .input-group {
        width: 100%;
        max-width: 417px;
    }

    .process-input {
        width: 100%;
        padding: 0.625rem 1rem;
        background-color: var(--table-bg);
        border: 1px solid var(--card-border);
        border-radius: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-primary);
        transition: all 0.2s;
    }

    .process-input::placeholder {
        color: var(--text-tertiary);
    }

    .process-input:focus {
        outline: none;
        border-color: var(--btn-primary-bg);
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }

    .run-button {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1.5rem;
        background-color: #16a34a;
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .run-button:hover {
        background-color: #15803d;
        transform: scale(1.02);
    }

    .run-button:active {
        transform: scale(0.98);
    }

    .btn-icon {
        width: 1rem;
        height: 1rem;
    }

    /* Quick Launch */
    .quick-launch {
        margin-top: 0.75rem;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.5rem;
    }

    .quick-label {
        font-size: 0.75rem;
        color: var(--text-tertiary);
        margin-right: 0.25rem;
    }

    .quick-btn {
        padding: 0.375rem 0.75rem;
        background-color: var(--table-bg);
        border: 1px solid var(--card-border);
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s;
    }

    .quick-btn:hover {
        background-color: var(--table-row-hover);
        border-color: var(--text-tertiary);
    }

    /* Table Styles */
    .task-manager-table-wrapper {
        overflow-x: auto;
    }

    .task-table {
        width: 100%;
        text-align: left;
        font-size: 0.875rem;
    }

    .task-table thead {
        background-color: var(--table-header-bg);
        color: var(--table-header-text);
        text-transform: uppercase;
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.05em;
    }

    .task-table th {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
    }

    .task-table tbody {
        color: var(--table-text);
    }

    .task-table tbody tr {
        border-bottom: 1px solid var(--table-border);
        transition: background-color 0.15s ease;
    }

    .task-table tbody tr:hover {
        background-color: var(--table-row-hover);
    }

    .task-table td {
        padding: 0.75rem 1.5rem;
    }

    .process-name {
        color: var(--table-text-primary);
    }

    .kill-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.75rem;
        background-color: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .kill-btn:hover {
        background-color: rgba(239, 68, 68, 0.2);
    }

    .text-center {
        text-align: center;
    }

    .cell-center {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .font-semibold {
        font-weight: 600;
    }

    @@media (max-width: 768px) {
        .input-row {
            flex-direction: column;
        }

        .input-group {
            min-width: 100%;
        }
    }
</style>