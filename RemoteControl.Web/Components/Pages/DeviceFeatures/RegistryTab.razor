@* 
    RegistryTab.razor - Registry Browser Component
    Full implementation with SignalR integration, search, and styling
*@

@using RemoteControl.Shared.Models
@using RemoteControl.Shared.Constants
@using Microsoft.AspNetCore.SignalR.Client
@using RemoteControl.Web.Components.Shared.Dialogs
@using RemoteControl.Web.Components.Shared.Registry
@inject IJSRuntime JS
@inject NavigationManager Nav
@implements IAsyncDisposable

<div class="registry-container" @onclick="CloseContextMenus">
    @* ====== TOOLBAR ====== *@
    <RegistryToolbar 
        CurrentPath="@_currentPath"
        CurrentPathChanged="path => _currentPath = path"
        SearchQuery="@_searchQuery"
        SearchQueryChanged="query => _searchQuery = query"
        CanGoBack="@(_historyStack.Count > 0)"
        OnNavigate="NavigateToPath"
        OnRefresh="RefreshCurrentKey"
        OnGoBack="GoBack"
        OnCreateKey="ShowCreateKeyDialog"
        OnCreateValue="() => ShowCreateValueDialog()"
        OnDelete="DeleteSelected" />

    @* ====== MAIN CONTENT - SPLIT PANEL ====== *@
    <div class="registry-content">
        @* LEFT PANEL: TreeView *@
        <div class="registry-tree-panel">
            <div class="tree-view">
                @foreach (var root in GetFilteredRootKeys())
                {
                    @RenderTreeNode(root, 0)
                }
            </div>
        </div>

        @* RIGHT PANEL: Values ListView *@
        <RegistryValuesTable 
            Values="@_values.Select(v => new RegistryValuesTable.RegistryValueInfo { Name = v.Name, Type = v.Type, Data = v.Data }).ToList()"
            SelectedValue="@(_selectedValue != null ? new RegistryValuesTable.RegistryValueInfo { Name = _selectedValue.Name, Type = _selectedValue.Type, Data = _selectedValue.Data } : null)"
            SearchQuery="@_searchQuery"
            IsLoading="@_isLoading"
            OnValueSelected="HandleValueSelected"
            OnValueEdit="HandleValueEdit"
            OnContextMenu="HandleValueContextMenu" />
    </div>

    @* ====== STATUS BAR ====== *@
    <div class="registry-status">
        @_statusMessage
    </div>

    @* ====== CONTEXT MENUS ====== *@
    @if (_showTreeContextMenu)
    {
        <div class="context-menu" style="left: @(_contextMenuX)px; top: @(_contextMenuY)px;" @onclick:stopPropagation="true">
            <div class="context-item" @onclick="ShowCreateKeyDialog">Create Subkey</div>
            <div class="context-item danger" @onclick="DeleteSelectedKey">Delete Key</div>
            <div class="context-separator"></div>
            <div class="context-item" @onclick="RefreshCurrentKey">Refresh</div>
            <div class="context-item" @onclick="CopyPathToClipboard">Copy Path</div>
        </div>
    }

    @if (_showValueContextMenu)
    {
        <div class="context-menu" style="left: @(_contextMenuX)px; top: @(_contextMenuY)px;" @onclick:stopPropagation="true">
            <div class="context-item" @onclick="() => EditValue(_selectedValue)">Edit Value</div>
            <div class="context-item danger" @onclick="DeleteSelectedValue">Delete Value</div>
            <div class="context-separator"></div>
            <div class="context-item" @onclick="CreateStringValue">New String Value</div>
            <div class="context-item" @onclick="CreateDwordValue">New DWORD Value</div>
            <div class="context-item" @onclick="CreateQwordValue">New QWORD Value</div>
            <div class="context-separator"></div>
            <div class="context-item" @onclick="CopyValueName">Copy Value Name</div>
            <div class="context-item" @onclick="CopyValueData">Copy Value Data</div>
        </div>
    }

    @* ====== DIALOGS ====== *@
    <InputDialog 
        Title="@_dialogTitle"
        Prompt="@_dialogPrompt"
        Value="@_dialogInput"
        IsVisible="@_showInputDialog"
        OnConfirm="HandleInputConfirm"
        OnCancel="CloseDialogs" />

    <ConfirmDialog 
        Title="@_dialogTitle"
        Message="@_dialogPrompt"
        IsVisible="@_showConfirmDialog"
        IsDanger="true"
        OnConfirm="HandleConfirmConfirm"
        OnCancel="CloseDialogs" />
</div>

@code {
    // ====== Parameters ======
    [CascadingParameter(Name = "AgentId")] public string AgentId { get; set; } = "";
    
    // ====== SignalR ======
    private HubConnection? _hubConnection;
    private bool IsConnected => _hubConnection?.State == HubConnectionState.Connected;

    // ====== State ======
    private string _currentPath = "HKEY_CURRENT_USER\\Software";
    private string _statusMessage = "Ready";
    private string _searchQuery = "";
    private bool _isLoading = false;
    
    private List<RegistryValueInfo> _values = new();
    private Stack<string> _historyStack = new();
    private RegistryValueInfo? _selectedValue;
    private TreeNode? _selectedNode;
    private List<TreeNode> _rootKeys = new();

    // Context menu state
    private bool _showTreeContextMenu = false;
    private bool _showValueContextMenu = false;
    private double _contextMenuX = 0;
    private double _contextMenuY = 0;

    // Dialog state
    private bool _showInputDialog = false;
    private bool _showConfirmDialog = false;
    private string _dialogTitle = "";
    private string _dialogPrompt = "";
    private string _dialogInput = "";
    private Func<Task>? _dialogCallback;

    // ====== Classes ======
    public class TreeNode
    {
        public string Name { get; set; } = "";
        public string FullPath { get; set; } = "";
        public bool IsExpanded { get; set; } = false;
        public bool IsLoaded { get; set; } = false;
        public bool IsLoading { get; set; } = false;
        public List<TreeNode> Children { get; set; } = new();
    }

    public class RegistryValueInfo
    {
        public string Name { get; set; } = "";
        public string Type { get; set; } = "";
        public string Data { get; set; } = "";
    }

    // ====== Lifecycle ======
    protected override async Task OnInitializedAsync()
    {
        InitializeRootKeys();
        
        // Create SignalR connection
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri("/remotehub"))
            .WithAutomaticReconnect()
            .Build();
        
        SetupSignalRHandlers();
        
        try
        {
            await _hubConnection.StartAsync();
            _statusMessage = "Connected to agent";
            Console.WriteLine("[RegistryTab] SignalR connected");
            await NavigateToPath();
        }
        catch (Exception ex)
        {
            _statusMessage = $"Connection failed: {ex.Message}";
            Console.WriteLine($"[RegistryTab] SignalR error: {ex.Message}");
        }
    }

    private void InitializeRootKeys()
    {
        _rootKeys = new List<TreeNode>
        {
            new() { Name = "HKEY_CLASSES_ROOT", FullPath = "HKEY_CLASSES_ROOT" },
            new() { Name = "HKEY_CURRENT_USER", FullPath = "HKEY_CURRENT_USER" },
            new() { Name = "HKEY_LOCAL_MACHINE", FullPath = "HKEY_LOCAL_MACHINE" },
            new() { Name = "HKEY_USERS", FullPath = "HKEY_USERS" },
            new() { Name = "HKEY_CURRENT_CONFIG", FullPath = "HKEY_CURRENT_CONFIG" }
        };
    }

    private void SetupSignalRHandlers()
    {
        if (_hubConnection == null) return;

        _hubConnection.On<CommandResult>(HubEvents.CommandCompleted, async (result) =>
        {
            // Filter by AgentId
            if (result.AgentId != AgentId) return;
            
            Console.WriteLine($"[RegistryTab] Received result: Success={result.Success}, Data type={result.Data?.GetType().Name}");
            
            if (!result.Success)
            {
                _statusMessage = $"Error: {result.Message}";
                _isLoading = false;
                await InvokeAsync(StateHasChanged);
                return;
            }

            // Parse JSON response like other tabs
            if (result.Data is System.Text.Json.JsonElement jsonElement)
            {
                var rawText = jsonElement.GetRawText();
                var options = new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                
                Console.WriteLine($"[RegistryTab] Raw JSON: {rawText.Substring(0, Math.Min(200, rawText.Length))}...");

                try
                {
                    // Check for SubKeys result (from ListRegistrySubKeys)
                    if (rawText.Contains("\"subKeys\"", StringComparison.OrdinalIgnoreCase))
                    {
                        var subKeysResult = System.Text.Json.JsonSerializer.Deserialize<RegistrySubKeysResult>(rawText, options);
                        if (subKeysResult?.SubKeys != null)
                        {
                            HandleSubKeysResult(subKeysResult);
                            Console.WriteLine($"[RegistryTab] Loaded {subKeysResult.SubKeys.Count} subkeys");
                        }
                    }
                    // Check for Values result (from ListRegistryValues)
                    else if (rawText.Contains("\"values\"", StringComparison.OrdinalIgnoreCase))
                    {
                        var valuesResult = System.Text.Json.JsonSerializer.Deserialize<RegistryValuesResult>(rawText, options);
                        if (valuesResult?.Values != null)
                        {
                            HandleValuesResult(valuesResult);
                            Console.WriteLine($"[RegistryTab] Loaded {valuesResult.Values.Count} values");
                        }
                    }
                    // Check for generic RegistryResult (from Write/Create/Delete)
                    else if (rawText.Contains("\"operationMessage\"", StringComparison.OrdinalIgnoreCase))
                    {
                        var regResult = System.Text.Json.JsonSerializer.Deserialize<RegistryResult>(rawText, options);
                        if (regResult != null)
                        {
                            _statusMessage = regResult.OperationMessage;
                            Console.WriteLine($"[RegistryTab] Operation result: {regResult.OperationMessage}");
                            // Don't auto-refresh here - let user manually refresh to avoid loops
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[RegistryTab] JSON parse error: {ex.Message}");
                }
            }
            
            _isLoading = false;
            await InvokeAsync(StateHasChanged);
        });
    }

    private void HandleSubKeysResult(RegistrySubKeysResult result)
    {
        if (_selectedNode != null)
        {
            _selectedNode.Children = result.SubKeys.Select(name => new TreeNode
            {
                Name = name,
                FullPath = $"{_selectedNode.FullPath}\\{name}"
            }).ToList();
            _selectedNode.IsLoaded = true;
            _selectedNode.IsLoading = false;
        }
    }

    private void HandleValuesResult(RegistryValuesResult result)
    {
        _values = result.Values.Select(v => new RegistryValueInfo
        {
            Name = string.IsNullOrEmpty(v.Name) ? "(Default)" : v.Name,
            Type = v.Type,
            Data = v.Data
        }).ToList();
        _statusMessage = $"Loaded {_values.Count} values from {_currentPath}";
    }

    // ====== Render Helper ======
    private RenderFragment RenderTreeNode(TreeNode node, int depth) => builder =>
    {
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", depth > 0 ? "tree-node child" : "tree-node");

        // Toggle
        builder.OpenElement(2, "span");
        builder.AddAttribute(3, "class", "node-toggle");
        builder.AddAttribute(4, "onclick", EventCallback.Factory.Create(this, () => ToggleNode(node)));
        builder.AddContent(5, node.IsLoading ? "⋯" : (node.IsExpanded ? "▼" : "▶"));
        builder.CloseElement();

        // Name
        builder.OpenElement(6, "span");
        builder.AddAttribute(7, "class", $"node-name {(node == _selectedNode ? "selected" : "")}");
        builder.AddAttribute(8, "onclick", EventCallback.Factory.Create(this, () => SelectNode(node)));
        builder.AddAttribute(9, "oncontextmenu", EventCallback.Factory.Create<MouseEventArgs>(this, e => ShowTreeContextMenu(e, node)));
        builder.AddEventPreventDefaultAttribute(10, "oncontextmenu", true);
        builder.AddContent(11, node.Name);
        builder.CloseElement();

        // Children
        if (node.IsExpanded && node.Children.Count > 0)
        {
            builder.OpenElement(12, "div");
            builder.AddAttribute(13, "class", "tree-children");
            foreach (var child in node.Children)
            {
                builder.AddContent(14, RenderTreeNode(child, depth + 1));
            }
            builder.CloseElement();
        }

        builder.CloseElement();
    };

    // ====== Search & Filter ======
    private List<TreeNode> GetFilteredRootKeys()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery)) return _rootKeys;
        return _rootKeys; // Tree filtering is complex, just show all roots
    }

    private List<RegistryValueInfo> GetFilteredValues()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery)) return _values;
        var query = _searchQuery.ToLowerInvariant();
        return _values.Where(v => 
            v.Name.ToLowerInvariant().Contains(query) || 
            v.Data.ToLowerInvariant().Contains(query)
        ).ToList();
    }

    private MarkupString HighlightMatch(string text)
    {
        if (string.IsNullOrWhiteSpace(_searchQuery) || string.IsNullOrEmpty(text))
            return new MarkupString(System.Web.HttpUtility.HtmlEncode(text));

        var query = _searchQuery;
        var index = text.IndexOf(query, StringComparison.OrdinalIgnoreCase);
        if (index < 0)
            return new MarkupString(System.Web.HttpUtility.HtmlEncode(text));

        var before = System.Web.HttpUtility.HtmlEncode(text.Substring(0, index));
        var match = System.Web.HttpUtility.HtmlEncode(text.Substring(index, query.Length));
        var after = System.Web.HttpUtility.HtmlEncode(text.Substring(index + query.Length));
        
        return new MarkupString($"{before}<mark class=\"search-highlight\">{match}</mark>{after}");
    }

    private void HandleSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Escape") ClearSearch();
    }

    private void ClearSearch()
    {
        _searchQuery = "";
    }

    // ====== Navigation ======
    private async Task NavigateToPath()
    {
        _isLoading = true;
        CloseContextMenus();
        StateHasChanged();

        if (_hubConnection?.State == HubConnectionState.Connected)
        {
            var request = new CommandRequest
            {
                AgentId = AgentId,
                Type = CommandType.ListRegistryValues,
                RegistryKeyPath = _currentPath
            };
            await _hubConnection.InvokeAsync("SendCommand", request);
        }
        else
        {
            _statusMessage = "Not connected to agent";
            _isLoading = false;
        }
    }

    private void HandlePathKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            _ = NavigateToPath();
        }
    }

    private async Task RefreshCurrentKey()
    {
        await NavigateToPath();
    }

    private void GoBack()
    {
        if (_historyStack.Count > 0)
        {
            _currentPath = _historyStack.Pop();
            _ = NavigateToPath();
        }
    }

    // ====== Tree Operations ======
    private async Task ToggleNode(TreeNode node)
    {
        node.IsExpanded = !node.IsExpanded;
        
        if (node.IsExpanded && !node.IsLoaded && _hubConnection?.State == HubConnectionState.Connected)
        {
            node.IsLoading = true;
            _selectedNode = node;
            
            var request = new CommandRequest
            {
                AgentId = AgentId,
                Type = CommandType.ListRegistrySubKeys,
                RegistryKeyPath = node.FullPath
            };
            await _hubConnection.InvokeAsync("SendCommand", request);
        }
        
        StateHasChanged();
    }

    private async Task SelectNode(TreeNode node)
    {
        _selectedNode = node;
        _historyStack.Push(_currentPath);
        _currentPath = node.FullPath;
        await NavigateToPath();
    }

    // ====== Value Operations ======
    private void HandleValueSelected(RegistryValuesTable.RegistryValueInfo value)
    {
        _selectedValue = _values.FirstOrDefault(v => v.Name == value.Name);
        CloseContextMenus();
    }

    private void HandleValueEdit(RegistryValuesTable.RegistryValueInfo value)
    {
        var original = _values.FirstOrDefault(v => v.Name == value.Name);
        if (original != null) EditValue(original);
    }

    private void HandleValueContextMenu((MouseEventArgs e, RegistryValuesTable.RegistryValueInfo value) args)
    {
        var original = _values.FirstOrDefault(v => v.Name == args.value.Name);
        if (original != null) ShowValueContextMenu(args.e, original);
    }

    private void SelectValue(RegistryValueInfo value)
    {
        _selectedValue = value;
        CloseContextMenus();
    }

    private void EditValue(RegistryValueInfo? value)
    {
        if (value == null) return;
        
        _dialogTitle = $"Edit: {value.Name}";
        _dialogPrompt = $"Type: {value.Type}\nEnter new data:";
        _dialogInput = value.Data;
        _dialogCallback = async () =>
        {
            if (_hubConnection?.State == HubConnectionState.Connected)
            {
                var valueName = value.Name == "(Default)" ? "" : value.Name;
                var request = new CommandRequest
                {
                    AgentId = AgentId,
                    Type = CommandType.WriteRegistry,
                    RegistryKeyPath = _currentPath,
                    RegistryValueName = valueName,
                    RegistryValue = _dialogInput,
                    RegistryValueType = value.Type
                };
                await _hubConnection.InvokeAsync("SendCommand", request);
            }
        };
        _showInputDialog = true;
        CloseContextMenus();
    }

    // ====== CRUD Operations ======
    private void ShowCreateKeyDialog()
    {
        _dialogTitle = "Create New Key";
        _dialogPrompt = "Enter key name:";
        _dialogInput = "NewKey";
        _dialogCallback = async () =>
        {
            if (_hubConnection?.State == HubConnectionState.Connected)
            {
                var request = new CommandRequest
                {
                    AgentId = AgentId,
                    Type = CommandType.CreateRegistryKey,
                    RegistryKeyPath = $"{_currentPath}\\{_dialogInput}"
                };
                await _hubConnection.InvokeAsync("SendCommand", request);
            }
        };
        _showInputDialog = true;
        CloseContextMenus();
    }

    private void ShowCreateValueDialog(string valueType = "REG_SZ")
    {
        _dialogTitle = $"Create New {valueType} Value";
        _dialogPrompt = "Enter value name:";
        _dialogInput = "NewValue";
        _dialogCallback = async () =>
        {
            if (_hubConnection?.State == HubConnectionState.Connected)
            {
                var request = new CommandRequest
                {
                    AgentId = AgentId,
                    Type = CommandType.WriteRegistry,
                    RegistryKeyPath = _currentPath,
                    RegistryValueName = _dialogInput,
                    RegistryValue = "",
                    RegistryValueType = valueType
                };
                await _hubConnection.InvokeAsync("SendCommand", request);
            }
        };
        _showInputDialog = true;
        CloseContextMenus();
    }

    private void CreateStringValue() => ShowCreateValueDialog("REG_SZ");
    private void CreateDwordValue() => ShowCreateValueDialog("REG_DWORD");
    private void CreateQwordValue() => ShowCreateValueDialog("REG_QWORD");

    private void DeleteSelected()
    {
        if (_selectedValue != null)
            DeleteSelectedValue();
        else if (_selectedNode != null)
            DeleteSelectedKey();
        else
            _statusMessage = "Please select a key or value to delete";
    }

    private void DeleteSelectedKey()
    {
        if (_selectedNode == null) return;
        
        _dialogTitle = "Delete Key";
        _dialogPrompt = $"Delete key '{_selectedNode.Name}' and all its contents?";
        _dialogCallback = async () =>
        {
            if (_hubConnection?.State == HubConnectionState.Connected)
            {
                var request = new CommandRequest
                {
                    AgentId = AgentId,
                    Type = CommandType.DeleteRegistryKey,
                    RegistryKeyPath = _selectedNode.FullPath
                };
                await _hubConnection.InvokeAsync("SendCommand", request);
            }
        };
        _showConfirmDialog = true;
        CloseContextMenus();
    }

    private void DeleteSelectedValue()
    {
        if (_selectedValue == null) return;
        
        _dialogTitle = "Delete Value";
        _dialogPrompt = $"Delete value '{_selectedValue.Name}'?";
        _dialogCallback = async () =>
        {
            if (_hubConnection?.State == HubConnectionState.Connected)
            {
                var valueName = _selectedValue.Name == "(Default)" ? "" : _selectedValue.Name;
                var request = new CommandRequest
                {
                    AgentId = AgentId,
                    Type = CommandType.DeleteRegistryValue,
                    RegistryKeyPath = _currentPath,
                    RegistryValueName = valueName
                };
                await _hubConnection.InvokeAsync("SendCommand", request);
            }
        };
        _showConfirmDialog = true;
        CloseContextMenus();
    }

    // ====== Context Menus ======
    private void ShowTreeContextMenu(MouseEventArgs e, TreeNode node)
    {
        _selectedNode = node;
        _contextMenuX = e.ClientX;
        _contextMenuY = e.ClientY;
        _showTreeContextMenu = true;
        _showValueContextMenu = false;
    }

    private void ShowValueContextMenu(MouseEventArgs e, RegistryValueInfo value)
    {
        _selectedValue = value;
        _contextMenuX = e.ClientX;
        _contextMenuY = e.ClientY;
        _showValueContextMenu = true;
        _showTreeContextMenu = false;
    }

    private void CloseContextMenus()
    {
        _showTreeContextMenu = false;
        _showValueContextMenu = false;
    }

    // ====== Clipboard ======
    private async Task CopyPathToClipboard()
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", _currentPath);
        _statusMessage = "Path copied to clipboard";
        CloseContextMenus();
    }

    private async Task CopyValueName()
    {
        if (_selectedValue != null)
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", _selectedValue.Name);
            _statusMessage = "Value name copied";
        }
        CloseContextMenus();
    }

    private async Task CopyValueData()
    {
        if (_selectedValue != null)
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", _selectedValue.Data);
            _statusMessage = "Value data copied";
        }
        CloseContextMenus();
    }

    // ====== Dialog Handlers ======
    private async Task HandleInputConfirm(string value)
    {
        _dialogInput = value;
        if (_dialogCallback != null)
            await _dialogCallback();
        CloseDialogs();
    }

    private async Task HandleConfirmConfirm()
    {
        if (_dialogCallback != null)
            await _dialogCallback();
        CloseDialogs();
    }

    private void CloseDialogs()
    {
        _showInputDialog = false;
        _showConfirmDialog = false;
        _dialogCallback = null;
    }

    // ====== Helpers ======
    private string TruncateData(string data)
    {
        return data.Length > 100 ? data.Substring(0, 100) + "..." : data;
    }

    // ====== IAsyncDisposable ======
    public async ValueTask DisposeAsync()
    {
        if (_hubConnection != null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}

<style>
    /* ====== Container ====== */
    .registry-container {
        display: flex;
        flex-direction: column;
        height: 600px;
        gap: 0.5rem;
        background: var(--card-bg);
        border-radius: 0 0 0.75rem 0.75rem;
        padding: 0.75rem;
    }

    /* ====== Toolbar ====== */
    .registry-toolbar {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        background: var(--card-bg);
        border-radius: 0.5rem;
        border: 1px solid var(--card-border);
        flex-wrap: wrap;
    }

    .path-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
        min-width: 200px;
    }

    .path-label {
        color: var(--text-secondary);
        font-size: 0.75rem;
        font-weight: 500;
    }

    .registry-path-input {
        flex: 1;
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid var(--card-border);
        background: var(--body-bg);
        color: var(--text-primary);
        font-family: 'Courier New', monospace;
        font-size: 0.75rem;
    }

    .registry-path-input:focus {
        outline: 2px solid var(--accent-blue);
        outline-offset: 0;
    }

    /* Search */
    .search-group {
        display: flex;
        align-items: center;
        position: relative;
        min-width: 160px;
    }

    .registry-search-input {
        width: 100%;
        padding: 0.375rem 1.75rem 0.375rem 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid var(--card-border);
        background: var(--body-bg);
        color: var(--text-primary);
        font-size: 0.75rem;
    }

    .registry-search-input:focus {
        outline: 2px solid var(--accent-blue);
        outline-offset: 0;
    }

    .btn-clear-search {
        position: absolute;
        right: 0.375rem;
        background: transparent;
        border: none;
        color: var(--text-tertiary);
        cursor: pointer;
        font-size: 1rem;
        line-height: 1;
        padding: 0.125rem;
    }

    .btn-clear-search:hover {
        color: var(--text-primary);
    }

    .toolbar-separator {
        width: 1px;
        height: 24px;
        background: var(--card-border);
        margin: 0 0.25rem;
    }

    .btn {
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        border: none;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.75rem;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .btn-navigate { background: #14b8a6; color: white; }
    .btn-refresh { background: #3b82f6; color: white; }
    .btn-back { background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--card-border); }
    .btn-create-key { background: #10b981; color: white; }
    .btn-create-value { background: #3b82f6; color: white; }
    .btn-delete { background: #ef4444; color: white; }
    .btn-cancel { background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--card-border); }
    .btn-ok { background: #3b82f6; color: white; }
    .btn-danger { background: #ef4444; color: white; }

    /* ====== Content Split ====== */
    .registry-content {
        display: flex;
        flex: 1;
        gap: 0.5rem;
        min-height: 0;
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .registry-tree-panel {
        width: 280px;
        min-width: 200px;
        background: var(--body-bg);
        border: 1px solid var(--card-border);
        overflow: auto;
        padding: 0.5rem;
        border-radius: 0.5rem 0 0 0.5rem;
    }

    .registry-values-panel {
        flex: 1;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        overflow: auto;
        border-radius: 0 0.5rem 0.5rem 0;
    }

    /* ====== TreeView ====== */
    .tree-view {
        font-size: 0.75rem;
        font-family: 'Courier New', monospace;
    }

    .tree-node {
        padding: 0.125rem 0;
    }

    .tree-node.child {
        margin-left: 1rem;
        padding-left: 0.5rem;
        border-left: 1px solid var(--card-border);
    }

    .tree-children {
        margin-left: 0.5rem;
    }

    .node-toggle {
        cursor: pointer;
        display: inline-block;
        width: 16px;
        text-align: center;
        color: var(--text-secondary);
        user-select: none;
    }

    .node-toggle:hover {
        color: var(--text-primary);
    }

    .node-name {
        cursor: pointer;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        color: var(--text-primary);
        user-select: none;
    }

    .node-name:hover {
        background: var(--card-hover);
    }

    .node-name.selected {
        background: var(--accent-blue);
        color: white;
    }

    /* ====== Values Table ====== */
    .values-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.75rem;
    }

    .values-table thead {
        background: var(--body-bg);
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .values-table th {
        padding: 0.5rem 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
        border-bottom: 1px solid var(--card-border);
    }

    .values-table td {
        padding: 0.5rem 1rem;
        border-bottom: 1px solid var(--card-border);
    }

    .values-table tbody tr {
        cursor: pointer;
        transition: background-color 0.15s;
    }

    .values-table tbody tr:hover {
        background: var(--card-hover);
    }

    .values-table tbody tr.selected {
        background: var(--accent-blue);
        color: white;
    }

    .col-name {
        font-weight: 500;
        color: var(--text-primary);
    }

    .col-type {
        color: var(--text-secondary);
    }

    .col-data {
        font-family: 'Courier New', monospace;
        color: var(--text-secondary);
    }

    .loading-cell,
    .empty-cell {
        text-align: center;
        color: var(--text-secondary);
        padding: 2rem !important;
    }

    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid var(--card-border);
        border-top-color: var(--accent-blue);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-right: 0.5rem;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .search-highlight {
        background: rgba(251, 191, 36, 0.3);
        padding: 0 2px;
        border-radius: 2px;
    }

    /* ====== Status Bar ====== */
    .registry-status {
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
        color: var(--text-secondary);
        background: var(--body-bg);
        border-radius: 0.375rem;
        border: 1px solid var(--card-border);
    }

    /* ====== Context Menu ====== */
    .context-menu {
        position: fixed;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 0.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        padding: 0.25rem;
        min-width: 180px;
        z-index: 1000;
    }

    .context-item {
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
        cursor: pointer;
        border-radius: 0.25rem;
        transition: background-color 0.15s;
        color: var(--text-primary);
    }

    .context-item:hover {
        background: var(--card-hover);
    }

    .context-item.danger {
        color: #ef4444;
    }

    .context-separator {
        height: 1px;
        background: var(--card-border);
        margin: 0.25rem 0;
    }
</style>
