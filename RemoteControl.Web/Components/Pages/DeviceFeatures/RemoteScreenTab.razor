@using RemoteControl.Shared.Models
@using RemoteControl.Shared.Constants
@using Microsoft.AspNetCore.SignalR.Client
@inject IJSRuntime JSRuntime
@inject NavigationManager Nav
@implements IAsyncDisposable

@* Remote Screen Tab Component - Displays live screen stream with capture controls *@

<div class="remote-screen-tab">
    <!-- Screen Container - Fixed max dimensions -->
    <div class="screen-container-wrapper">
        <!-- Screen Container -->
        <div class="screen-container">
            <!-- Screen Display Area -->
            <div id="screen-display" class="screen-display" style="transform: scale(@ZoomLevel); transform-origin: center center;">
                @if (!string.IsNullOrEmpty(CurrentScreenshot.ImageBase64))
                {
                    <img src="data:image/@CurrentScreenshot.Format;base64,@CurrentScreenshot.ImageBase64" 
                         alt="Remote Desktop Screen" class="screen-image" />
                }
                else
                {
                    <div class="no-capture-placeholder">
                        <svg class="placeholder-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        <p>Click "Capture Screen" to take a screenshot</p>
                    </div>
                }
            </div>
        </div>

        <!-- Action Toolbar -->
        <div class="action-toolbar-container">
            <div class="action-toolbar">
                <!-- Capture Screen -->
                <button class="action-btn action-btn-blue @(IsCapturing ? "btn-loading" : "")" 
                        @onclick="CaptureScreen" disabled="@IsCapturing">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>@(IsCapturing ? "Capturing..." : "Capture Screen")</span>
                </button>

                <!-- Save to Device -->
                <button class="action-btn action-btn-green" @onclick="SaveToDevice">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    <span>Save to Device</span>
                </button>

                <!-- Copy to Clipboard -->
                <button class="action-btn action-btn-purple" @onclick="CopyImage">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    <span>Copy Image</span>
                </button>

                <!-- Divider -->
                <div class="toolbar-divider"></div>

                <!-- Icon-only buttons -->
                <button class="icon-btn" title="Fullscreen" @onclick="ToggleFullscreen">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                    </svg>
                </button>

                <button class="icon-btn" title="Zoom In" @onclick="ZoomIn">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7" />
                    </svg>
                </button>

                <button class="icon-btn" title="Zoom Out" @onclick="ZoomOut">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7" />
                    </svg>
                </button>
            </div>

            <!-- Info Bar -->
            <div class="info-bar">
                <span>Resolution: @GetResolutionDisplay()</span>
                <span>Format: @CurrentScreenshot.Format.ToUpper()</span>
                <span>Last capture: @GetLastCaptureDisplay()</span>
                <span class="@GetStatusClass()">Status: @CaptureStatus</span>
            </div>
        </div>
    </div>
</div>

@code {
    // CascadingParameter from DeviceControl
    [CascadingParameter(Name = "AgentId")]
    public string AgentId { get; set; } = string.Empty;

    // SignalR
    private HubConnection? _hubConnection;
    private bool IsConnected => _hubConnection?.State == HubConnectionState.Connected;

    // Screenshot result
    private ScreenshotResult CurrentScreenshot { get; set; } = new()
    {
        ImageBase64 = "", // Will be populated by SignalR
        Width = 1920,
        Height = 1080,
        Format = "jpeg",
        CapturedAt = DateTime.Now.AddMinutes(-2)
    };

    private string CaptureStatus { get; set; } = "Ready";
    private bool IsCapturing { get; set; } = false;
    private double ZoomLevel { get; set; } = 1.0; // 100%

    // Helper: Format resolution from model
    private string GetResolutionDisplay() => $"{CurrentScreenshot.Width}Ã—{CurrentScreenshot.Height}";

    // Helper: Format last capture time in friendly way
    private string GetLastCaptureDisplay()
    {
        var captureTime = CurrentScreenshot.CapturedAt;
        if (captureTime == default) return "Never";
        
        var elapsed = DateTime.Now - captureTime;
        
        if (elapsed.TotalSeconds < 30) return "Just now";
        if (elapsed.TotalMinutes < 1) return "Less than 1 min ago";
        if (elapsed.TotalMinutes < 60) return $"{(int)elapsed.TotalMinutes} min ago";
        if (elapsed.TotalHours < 24) return $"{(int)elapsed.TotalHours} hr ago";
        return captureTime.ToString("MMM dd, HH:mm");
    }

    // Helper: Status color class
    private string GetStatusClass()
    {
        return CaptureStatus switch
        {
            "Ready" => "status-ready",
            "Capturing..." => "status-capturing",
            "Error" => "status-error",
            _ => ""
        };
    }

    protected override async Task OnInitializedAsync()
    {
        await InitializeSignalR();
    }

    private async Task InitializeSignalR()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri("/remotehub"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<CommandResult>(HubEvents.CommandCompleted, OnCommandCompleted);

        try
        {
            await _hubConnection.StartAsync();
            Console.WriteLine("[RemoteScreen] SignalR connected");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[RemoteScreen] SignalR error: {ex.Message}");
        }
    }

    private void OnCommandCompleted(CommandResult result)
    {
        if (result.AgentId != AgentId) return;
        
        if (!result.Success) 
        {
            CaptureStatus = "Error";
            IsCapturing = false;
            InvokeAsync(StateHasChanged);
            return;
        }

        // ScreenshotResult is stored in CommandResult.Data
        if (result.Data is System.Text.Json.JsonElement jsonElement)
        {
            try
            {
                var screenshotResult = System.Text.Json.JsonSerializer.Deserialize<ScreenshotResult>(
                    jsonElement.GetRawText(),
                    new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                
                if (screenshotResult != null && !string.IsNullOrEmpty(screenshotResult.ImageBase64))
                {
                    CurrentScreenshot = screenshotResult;
                    CaptureStatus = "Ready";
                    IsCapturing = false;
                    Console.WriteLine($"[RemoteScreen] Received screenshot: {screenshotResult.Width}x{screenshotResult.Height}");
                    InvokeAsync(StateHasChanged);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[RemoteScreen] Parse error: {ex.Message}");
                CaptureStatus = "Error";
                IsCapturing = false;
                InvokeAsync(StateHasChanged);
            }
        }
    }

    // Action methods
    private async Task CaptureScreen()
    {
        if (_hubConnection == null || !IsConnected) 
        {
            Console.WriteLine("[RemoteScreen] Not connected to SignalR");
            return;
        }
        if (string.IsNullOrEmpty(AgentId)) 
        {
            Console.WriteLine("[RemoteScreen] AgentId is empty");
            return;
        }

        CaptureStatus = "Capturing...";
        IsCapturing = true;
        StateHasChanged();

        var request = CommandRequest.CreateCaptureScreen(AgentId);
        await _hubConnection.InvokeAsync("SendCommand", request);
        Console.WriteLine($"[RemoteScreen] Capture screen requested for {AgentId}");
    }

    private async Task SaveToDevice()
    {
        if (string.IsNullOrEmpty(CurrentScreenshot.ImageBase64))
        {
            Console.WriteLine("[RemoteScreen] No screenshot to save");
            return;
        }

        var fileName = $"screenshot_{DateTime.Now:yyyyMMdd_HHmmss}.{CurrentScreenshot.Format}";
        var dataUrl = $"data:image/{CurrentScreenshot.Format};base64,{CurrentScreenshot.ImageBase64}";
        
        await JSRuntime.InvokeVoidAsync("downloadImage", fileName, dataUrl);
        Console.WriteLine($"[RemoteScreen] Saved: {fileName}");
    }

    private async Task CopyImage()
    {
        if (string.IsNullOrEmpty(CurrentScreenshot.ImageBase64))
        {
            Console.WriteLine("[RemoteScreen] No screenshot to copy");
            return;
        }

        var dataUrl = $"data:image/{CurrentScreenshot.Format};base64,{CurrentScreenshot.ImageBase64}";
        await JSRuntime.InvokeVoidAsync("copyImageToClipboard", dataUrl);
        Console.WriteLine("[RemoteScreen] Image copied to clipboard");
    }

    private async Task ToggleFullscreen()
    {
        await JSRuntime.InvokeVoidAsync("toggleFullscreen", "screen-display");
        Console.WriteLine("[RemoteScreen] Toggle fullscreen");
    }

    private void ZoomIn()
    {
        ZoomLevel = Math.Min(ZoomLevel + 0.25, 3.0); // Max 300%
        Console.WriteLine($"[RemoteScreen] Zoom: {ZoomLevel:P0}");
    }

    private void ZoomOut()
    {
        ZoomLevel = Math.Max(ZoomLevel - 0.25, 0.25); // Min 25%
        Console.WriteLine($"[RemoteScreen] Zoom: {ZoomLevel:P0}");
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection != null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}

<style>
    .remote-screen-tab {
        padding: 1.5rem;
        min-height: 500px;
        background-color: var(--card-bg);
        border-radius: 0 0 0.75rem 0.75rem;
    }

    .screen-container-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    /* Screen Container - Fixed max dimensions */
    .screen-container {
        position: relative;
        width: 100%;
        max-width: 56rem;
        /* max-w-4xl */
        background-color: #000;
        border-radius: 0.5rem;
        overflow: hidden;
        border: 2px solid var(--card-border);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    /* No Capture Placeholder */
    .no-capture-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        min-height: 400px;
        color: var(--text-tertiary);
    }

    .placeholder-icon {
        width: 4rem;
        height: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .no-capture-placeholder p {
        font-size: 0.875rem;
        text-align: center;
    }

    .btn-loading {
        opacity: 0.7;
        cursor: wait;
    }

    /* Live Indicator */
    .live-indicator {
        position: absolute;
        top: 0.75rem;
        left: 0.75rem;
        z-index: 10;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .live-dot {
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 9999px;
        background-color: #ef4444;
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        box-shadow: 0 0 8px rgba(239, 68, 68, 0.8);
    }

    .live-text {
        font-size: 0.75rem;
        font-weight: 700;
        color: white;
        letter-spacing: 0.05em;
    }

    /* Status Indicator */
    .status-indicator {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        z-index: 10;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .status-text {
        font-size: 0.75rem;
        font-weight: 500;
        color: #4ade80;
    }

    /* Screen Display Area */
    .screen-display {
        aspect-ratio: 16 / 9;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(to bottom right, #1f2937, #000, #1f2937);
    }

    .screen-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    /* Action Toolbar */
    .action-toolbar-container {
        width: 100%;
        max-width: 56rem;
    }

    .action-toolbar {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        padding: 1rem;
        background-color: var(--table-bg);
        border-radius: 0.5rem;
        border: 1px solid var(--card-border);
    }

    /* Action Buttons */
    .action-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
        color: white;
    }

    .action-btn:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        transform: scale(1.05);
    }

    .action-btn:active {
        transform: scale(0.95);
    }

    .action-btn-blue {
        background-color: #2563eb;
    }

    .action-btn-blue:hover {
        background-color: #1d4ed8;
    }

    .action-btn-green {
        background-color: #16a34a;
    }

    .action-btn-green:hover {
        background-color: #15803d;
    }

    .action-btn-purple {
        background-color: #9333ea;
    }

    .action-btn-purple:hover {
        background-color: #7e22ce;
    }

    .action-btn-orange {
        background-color: #ea580c;
    }

    .action-btn-orange:hover {
        background-color: #c2410c;
    }

    .btn-icon {
        width: 1rem;
        height: 1rem;
    }

    /* Toolbar Divider */
    .toolbar-divider {
        height: 2rem;
        width: 1px;
        background-color: var(--card-border);
        margin: 0 0.5rem;
    }

    /* Icon-only buttons */
    .icon-btn {
        padding: 0.625rem;
        background-color: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 0.5rem;
        transition: all 0.2s;
        cursor: pointer;
        color: var(--text-primary);
    }

    .icon-btn:hover {
        background-color: var(--table-row-hover);
        transform: scale(1.1);
    }

    .icon-btn:active {
        transform: scale(0.95);
    }

    /* Info Bar */
    .info-bar {
        margin-top: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--text-tertiary);
        padding: 0 0.5rem;
    }

    .status-ready {
        color: #22c55e;
    }

    .status-capturing {
        color: #eab308;
    }

    .status-error {
        color: #ef4444;
    }

    @@keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .action-toolbar {
            flex-direction: column;
        }

        .info-bar {
            flex-direction: column;
            gap: 0.25rem;
        }
    }
</style>