@using RemoteControl.Shared.Models
@using RemoteControl.Shared.Constants
@using Microsoft.AspNetCore.SignalR.Client
@inject IJSRuntime JSRuntime
@inject NavigationManager Nav
@implements IAsyncDisposable

@* Remote Screen Tab Component - Displays live screen stream with capture controls *@

<div class="remote-screen-tab">
    <!-- Screen Container - Fixed max dimensions -->
    <div class="screen-container-wrapper">
        <!-- Screen Container -->
        <div class="screen-container">
            <!-- Screen Display Area - Click to open lightbox -->
            <div class="screen-display" @onclick="OpenLightbox" style="cursor: pointer;" title="Click to view fullscreen">
                @if (!string.IsNullOrEmpty(CurrentScreenshot.ImageBase64))
                {
                    <img src="data:image/@CurrentScreenshot.Format;base64,@CurrentScreenshot.ImageBase64" 
                         alt="Remote Desktop Screen" class="screen-image" />
                }
                else
                {
                    <div class="no-capture-placeholder">
                        <svg class="placeholder-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        <p>Click "Capture Screen" to take a screenshot</p>
                    </div>
                }
            </div>
        </div>

        <!-- Action Toolbar -->
        <div class="action-toolbar-container">
            <div class="action-toolbar">
                <!-- Capture Screen -->
                <button class="action-btn action-btn-blue @(IsCapturing ? "btn-loading" : "")" 
                        @onclick="CaptureScreen" disabled="@IsCapturing">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>@(IsCapturing ? "Capturing..." : "Capture Screen")</span>
                </button>

                <!-- Save to Device -->
                <button class="action-btn action-btn-green" @onclick="SaveToDevice">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    <span>Save to Device</span>
                </button>

                <!-- Copy to Clipboard -->
                <button class="action-btn action-btn-purple" @onclick="CopyImage">
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    <span>Copy Image</span>
                </button>
            </div>

            <!-- Info Bar -->
            <div class="info-bar">
                <span>Resolution: @GetResolutionDisplay()</span>
                <span>Format: @CurrentScreenshot.Format.ToUpper()</span>
                <span>Last capture: @GetLastCaptureDisplay()</span>
                <span class="@GetStatusClass()">Status: @CaptureStatus</span>
            </div>
        </div>
    </div>
</div>

@* Lightbox Modal - Image Viewer *@
@if (IsLightboxOpen && !string.IsNullOrEmpty(CurrentScreenshot.ImageBase64))
{
    <div class="lightbox-overlay" @onclick="CloseLightbox">
        <div class="lightbox-container" @onclick:stopPropagation="true">
            <!-- Close Button -->
            <button class="lightbox-close" @onclick="CloseLightbox" title="Close (ESC)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <!-- Image -->
            <div class="lightbox-image-wrapper">
                <img src="data:image/@CurrentScreenshot.Format;base64,@CurrentScreenshot.ImageBase64"
                     alt="Screenshot Preview"
                     class="lightbox-image"
                     style="transform: scale(@LightboxZoom.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)) rotate(@(LightboxRotate)deg);" />
            </div>

            <!-- Toolbar -->
            <div class="lightbox-toolbar">
                <button class="lightbox-btn" @onclick="LightboxZoomIn" title="Zoom In">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6" />
                    </svg>
                </button>
                <button class="lightbox-btn" @onclick="LightboxZoomOut" title="Zoom Out">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
                    </svg>
                </button>
                <div class="lightbox-divider"></div>
                <button class="lightbox-btn" @onclick="LightboxRotateLeft" title="Rotate Left">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                    </svg>
                </button>
                <button class="lightbox-btn" @onclick="LightboxRotateRight" title="Rotate Right">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6" />
                    </svg>
                </button>
                <div class="lightbox-divider"></div>
                <span class="lightbox-zoom-label">@((LightboxZoom * 100).ToString("F0"))%</span>
            </div>
        </div>
    </div>
}

@code {
    // CascadingParameter from DeviceControl
    [CascadingParameter(Name = "AgentId")]
    public string AgentId { get; set; } = string.Empty;

    // SignalR
    private HubConnection? _hubConnection;
    private bool IsConnected => _hubConnection?.State == HubConnectionState.Connected;

    // Timer to refresh info bar (for "Last capture" display)
    private System.Timers.Timer? _infoRefreshTimer;

    // Screenshot result
    private ScreenshotResult CurrentScreenshot { get; set; } = new()
    {
        ImageBase64 = "", // Will be populated by SignalR
        Width = 1920,
        Height = 1080,
        Format = "jpeg",
        CapturedAt = DateTime.Now.AddMinutes(-2)
    };

    private string CaptureStatus { get; set; } = "Ready";
    private bool IsCapturing { get; set; } = false;

    // Lightbox state
    private bool IsLightboxOpen { get; set; } = false;
    private double LightboxZoom { get; set; } = 1.0;
    private int LightboxRotate { get; set; } = 0;

    // Helper: Format resolution from model
    private string GetResolutionDisplay() => $"{CurrentScreenshot.Width}Ã—{CurrentScreenshot.Height}";

    // Helper: Format last capture time in friendly way
    private string GetLastCaptureDisplay()
    {
        var captureTime = CurrentScreenshot.CapturedAt;
        if (captureTime == default) return "Never";
        
        // Use UtcNow because CapturedAt is stored in UTC
        var elapsed = DateTime.UtcNow - captureTime;
        
        if (elapsed.TotalSeconds < 30) return "Just now";
        if (elapsed.TotalMinutes < 1) return "Less than 1 min ago";
        if (elapsed.TotalMinutes < 60) return $"{(int)elapsed.TotalMinutes} min ago";
        if (elapsed.TotalHours < 24) return $"{(int)elapsed.TotalHours} hr ago";
        return captureTime.ToLocalTime().ToString("MMM dd, HH:mm");
    }

    // Helper: Status color class
    private string GetStatusClass()
    {
        return CaptureStatus switch
        {
            "Ready" => "status-ready",
            "Capturing..." => "status-capturing",
            "Error" => "status-error",
            _ => ""
        };
    }

    protected override async Task OnInitializedAsync()
    {
        await InitializeSignalR();

        // Auto-refresh info bar every 30 seconds to update "Last capture" display
        _infoRefreshTimer = new System.Timers.Timer(30000);
        _infoRefreshTimer.Elapsed += (s, e) => InvokeAsync(StateHasChanged);
        _infoRefreshTimer.Start();
    }

    private async Task InitializeSignalR()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri("/remotehub"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<CommandResult>(HubEvents.CommandCompleted, OnCommandCompleted);

        try
        {
            await _hubConnection.StartAsync();
            Console.WriteLine("[RemoteScreen] SignalR connected");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[RemoteScreen] SignalR error: {ex.Message}");
        }
    }

    private void OnCommandCompleted(CommandResult result)
    {
        if (result.AgentId != AgentId) return;
        
        if (!result.Success) 
        {
            CaptureStatus = "Error";
            IsCapturing = false;
            InvokeAsync(StateHasChanged);
            return;
        }

        // ScreenshotResult is stored in CommandResult.Data
        if (result.Data is System.Text.Json.JsonElement jsonElement)
        {
            try
            {
                var screenshotResult = System.Text.Json.JsonSerializer.Deserialize<ScreenshotResult>(
                    jsonElement.GetRawText(),
                    new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                
                if (screenshotResult != null && !string.IsNullOrEmpty(screenshotResult.ImageBase64))
                {
                    CurrentScreenshot = screenshotResult;
                    CaptureStatus = "Ready";
                    IsCapturing = false;
                    Console.WriteLine($"[RemoteScreen] Received screenshot: {screenshotResult.Width}x{screenshotResult.Height}");
                    InvokeAsync(StateHasChanged);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[RemoteScreen] Parse error: {ex.Message}");
                CaptureStatus = "Error";
                IsCapturing = false;
                InvokeAsync(StateHasChanged);
            }
        }
    }

    // Action methods
    private async Task CaptureScreen()
    {
        if (_hubConnection == null || !IsConnected) 
        {
            Console.WriteLine("[RemoteScreen] Not connected to SignalR");
            return;
        }
        if (string.IsNullOrEmpty(AgentId)) 
        {
            Console.WriteLine("[RemoteScreen] AgentId is empty");
            return;
        }

        CaptureStatus = "Capturing...";
        IsCapturing = true;
        StateHasChanged();

        var request = CommandRequest.CreateCaptureScreen(AgentId);
        await _hubConnection.InvokeAsync("SendCommand", request);
        Console.WriteLine($"[RemoteScreen] Capture screen requested for {AgentId}");
    }

    private async Task SaveToDevice()
    {
        if (string.IsNullOrEmpty(CurrentScreenshot.ImageBase64))
        {
            Console.WriteLine("[RemoteScreen] No screenshot to save");
            return;
        }

        var fileName = $"screenshot_{DateTime.Now:yyyyMMdd_HHmmss}.{CurrentScreenshot.Format}";
        var dataUrl = $"data:image/{CurrentScreenshot.Format};base64,{CurrentScreenshot.ImageBase64}";
        
        await JSRuntime.InvokeVoidAsync("downloadImage", fileName, dataUrl);
        Console.WriteLine($"[RemoteScreen] Saved: {fileName}");
    }

    private async Task CopyImage()
    {
        if (string.IsNullOrEmpty(CurrentScreenshot.ImageBase64))
        {
            Console.WriteLine("[RemoteScreen] No screenshot to copy");
            return;
        }

        var dataUrl = $"data:image/{CurrentScreenshot.Format};base64,{CurrentScreenshot.ImageBase64}";
        await JSRuntime.InvokeVoidAsync("copyImageToClipboard", dataUrl);
        Console.WriteLine("[RemoteScreen] Image copied to clipboard");
    }

    // Lightbox methods
    private void OpenLightbox()
    {
        if (string.IsNullOrEmpty(CurrentScreenshot.ImageBase64)) return;
        IsLightboxOpen = true;
        LightboxZoom = 1.0;
        LightboxRotate = 0;
    }

    private void CloseLightbox()
    {
        IsLightboxOpen = false;
    }

    private void LightboxZoomIn()
    {
        LightboxZoom = Math.Min(LightboxZoom + 0.25, 4.0); // Max 400%
    }

    private void LightboxZoomOut()
    {
        LightboxZoom = Math.Max(LightboxZoom - 0.25, 0.25); // Min 25%
    }

    private void LightboxRotateLeft()
    {
        LightboxRotate = (LightboxRotate - 90) % 360;
    }

    private void LightboxRotateRight()
    {
        LightboxRotate = (LightboxRotate + 90) % 360;
    }

    public async ValueTask DisposeAsync()
    {
        _infoRefreshTimer?.Stop();
        _infoRefreshTimer?.Dispose();

        if (_hubConnection != null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}

<style>
    .remote-screen-tab {
        padding: 1.5rem;
        min-height: 500px;
        background-color: var(--card-bg);
        border-radius: 0 0 0.75rem 0.75rem;
    }

    .screen-container-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    /* Screen Container - Fixed max dimensions */
    .screen-container {
        position: relative;
        width: 100%;
        max-width: 56rem;
        /* max-w-4xl */
        background-color: #000;
        border-radius: 0.5rem;
        overflow: hidden;
        border: 2px solid var(--card-border);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    /* No Capture Placeholder */
    .no-capture-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        min-height: 400px;
        color: var(--text-tertiary);
    }

    .placeholder-icon {
        width: 4rem;
        height: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .no-capture-placeholder p {
        font-size: 0.875rem;
        text-align: center;
    }

    .btn-loading {
        opacity: 0.7;
        cursor: wait;
    }

    /* Live Indicator */
    .live-indicator {
        position: absolute;
        top: 0.75rem;
        left: 0.75rem;
        z-index: 10;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .live-dot {
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 9999px;
        background-color: #ef4444;
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        box-shadow: 0 0 8px rgba(239, 68, 68, 0.8);
    }

    .live-text {
        font-size: 0.75rem;
        font-weight: 700;
        color: white;
        letter-spacing: 0.05em;
    }

    /* Status Indicator */
    .status-indicator {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        z-index: 10;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .status-text {
        font-size: 0.75rem;
        font-weight: 500;
        color: #4ade80;
    }

    /* Screen Display Area */
    .screen-display {
        aspect-ratio: 16 / 9;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(to bottom right, #1f2937, #000, #1f2937);
    }

    .screen-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    /* Action Toolbar */
    .action-toolbar-container {
        width: 100%;
        max-width: 56rem;
    }

    .action-toolbar {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        padding: 1rem;
        background-color: var(--table-bg);
        border-radius: 0.5rem;
        border: 1px solid var(--card-border);
    }

    /* Action Buttons */
    .action-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
        color: white;
    }

    .action-btn:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        transform: scale(1.05);
    }

    .action-btn:active {
        transform: scale(0.95);
    }

    .action-btn-blue {
        background-color: #2563eb;
    }

    .action-btn-blue:hover {
        background-color: #1d4ed8;
    }

    .action-btn-green {
        background-color: #16a34a;
    }

    .action-btn-green:hover {
        background-color: #15803d;
    }

    .action-btn-purple {
        background-color: #9333ea;
    }

    .action-btn-purple:hover {
        background-color: #7e22ce;
    }

    .action-btn-orange {
        background-color: #ea580c;
    }

    .action-btn-orange:hover {
        background-color: #c2410c;
    }

    .btn-icon {
        width: 1rem;
        height: 1rem;
    }

    /* Toolbar Divider */
    .toolbar-divider {
        height: 2rem;
        width: 1px;
        background-color: var(--card-border);
        margin: 0 0.5rem;
    }

    /* Icon-only buttons */
    .icon-btn {
        padding: 0.625rem;
        background-color: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 0.5rem;
        transition: all 0.2s;
        cursor: pointer;
        color: var(--text-primary);
    }

    .icon-btn:hover {
        background-color: var(--table-row-hover);
        transform: scale(1.1);
    }

    .icon-btn:active {
        transform: scale(0.95);
    }

    /* Info Bar */
    .info-bar {
        margin-top: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--text-tertiary);
        padding: 0 0.5rem;
    }

    .status-ready {
        color: #22c55e;
    }

    .status-capturing {
        color: #eab308;
    }

    .status-error {
        color: #ef4444;
    }

    @@keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .action-toolbar {
            flex-direction: column;
        }

        .info-bar {
            flex-direction: column;
            gap: 0.25rem;
        }
    }

    /* ====== Lightbox Modal Styles ====== */
    .lightbox-overlay {
        position: fixed;
        inset: 0;
        z-index: 9999;
        background-color: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(8px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease-out;
    }

    .lightbox-container {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .lightbox-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 10;
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 9999px;
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .lightbox-close:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
    }

    .lightbox-close svg {
        width: 1.25rem;
        height: 1.25rem;
    }

    .lightbox-image-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        padding: 2rem;
    }

    .lightbox-image {
        max-width: 90vw;
        max-height: 80vh;
        object-fit: contain;
        border-radius: 0.5rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        transition: transform 0.2s ease-out;
    }

    .lightbox-toolbar {
        position: absolute;
        bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background-color: rgba(30, 30, 30, 0.9);
        backdrop-filter: blur(8px);
        padding: 0.75rem 1.25rem;
        border-radius: 9999px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
    }

    .lightbox-btn {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 9999px;
        background-color: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .lightbox-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
    }

    .lightbox-btn:active {
        transform: scale(0.95);
    }

    .lightbox-btn svg {
        width: 1.25rem;
        height: 1.25rem;
    }

    .lightbox-divider {
        width: 1px;
        height: 1.5rem;
        background-color: rgba(255, 255, 255, 0.2);
        margin: 0 0.25rem;
    }

    .lightbox-zoom-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.875rem;
        font-weight: 500;
        min-width: 3rem;
        text-align: center;
    }

    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
</style>