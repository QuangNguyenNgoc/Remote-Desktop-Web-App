@using RemoteControl.Shared.Models
@using RemoteControl.Shared.Constants
@using Microsoft.AspNetCore.SignalR.Client
@inject IJSRuntime JSRuntime
@inject NavigationManager Nav
@implements IAsyncDisposable

@* Remote Screen Tab Component - Enhanced with Capture/Stream/Record modes *@

<div class="remote-screen-tab">
    <!-- Screen Container - Fixed max dimensions -->
    <div class="screen-container-wrapper">
        <!-- Screen Container -->
        <div class="screen-container">
            <!-- Screen Display Area - Click to open lightbox -->
            <div class="screen-display" @onclick="OpenLightbox" style="cursor: pointer;" title="Click to view fullscreen">
                @if (!string.IsNullOrEmpty(CurrentScreenshot.ImageBase64))
                {
                    <img src="data:image/@CurrentScreenshot.Format;base64,@CurrentScreenshot.ImageBase64" 
                         alt="Remote Desktop Screen" class="screen-image" />
                }
                else
                {
                    <div class="no-capture-placeholder">
                        <svg class="placeholder-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        <p>Click "Capture Screen" to take a screenshot</p>
                    </div>
                }
            </div>
        </div>

        @* Added Mode Switcher - Segmented Control *@
        <div class="mode-switcher-container">
            <div class="mode-switcher">
                <button class="mode-btn @(CurrentMode == ScreenMode.Capture ? "active" : "")"
                        @onclick="() => SwitchMode(ScreenMode.Capture)">
                    <svg class="mode-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>Capture</span>
                </button>
                <button class="mode-btn @(CurrentMode == ScreenMode.Stream ? "active" : "")"
                        @onclick="() => SwitchMode(ScreenMode.Stream)">
                    <svg class="mode-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    <span>Stream</span>
                </button>
                <button class="mode-btn @(CurrentMode == ScreenMode.Record ? "active" : "")"
                        @onclick="() => SwitchMode(ScreenMode.Record)">
                    <svg class="mode-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                    </svg>
                    <span>Record</span>
                </button>
            </div>
        </div>

        @* Dynamic Action Toolbar based on Current Mode *@
        <div class="action-toolbar-container">
            @if (CurrentMode == ScreenMode.Capture)
            {
                <div class="action-toolbar">
                    <!-- Capture Screen -->
                    <button class="action-btn action-btn-blue @(IsCapturing ? "btn-loading" : "")" 
                            @onclick="CaptureScreen" disabled="@IsCapturing">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span>@(IsCapturing ? "Capturing..." : "Capture Screen")</span>
                    </button>

                    <!-- Save to Device -->
                    <button class="action-btn action-btn-green" @onclick="SaveToDevice">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        <span>Save to Device</span>
                    </button>

                    <!-- Copy to Clipboard -->
                    <button class="action-btn action-btn-purple" @onclick="CopyImage">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        <span>Copy Image</span>
                    </button>
                </div>

                <!-- Info Bar - Capture Mode -->
                <div class="info-bar">
                    <span>Resolution: @GetResolutionDisplay()</span>
                    <span>Format: @CurrentScreenshot.Format.ToUpper()</span>
                    <span>Last capture: @GetLastCaptureDisplay()</span>
                    <span class="@GetStatusClass()">Status: @CaptureStatus</span>
                </div>
            }
            else if (CurrentMode == ScreenMode.Stream)
            {
                <div class="action-toolbar">
                    <!-- Start Stream -->
                    <button class="action-btn action-btn-green" 
                            @onclick="StartStream" 
                            disabled="@IsStreaming">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>@(IsStreaming ? "Streaming..." : "Start Stream")</span>
                    </button>

                    <!-- Stop Stream -->
                    <button class="action-btn action-btn-red" 
                            @onclick="StopStream" 
                            disabled="@(!IsStreaming)">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                        </svg>
                        <span>Stop Stream</span>
                    </button>
                </div>

                <!-- Info Bar - Stream Mode -->
                <div class="info-bar">
                    <span>Resolution: @StreamResolution</span>
                    <span>FPS: @StreamFPS</span>
                    <span>Bitrate: @StreamBitrate</span>
                    <span class="@(IsStreaming ? "status-streaming" : "status-ready")">
                        Status: @(IsStreaming ? "Streaming" : "Ready")
                    </span>
                </div>
            }
            else if (CurrentMode == ScreenMode.Record)
            {
                <div class="action-toolbar">
                    <!-- Start Recording -->
                    <button class="action-btn action-btn-red" 
                            @onclick="StartRecording" 
                            disabled="@IsRecording">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                        </svg>
                        @if (IsRecording && RecordingPulse)
                        {
                            <span class="recording-indicator"></span>
                        }
                        <span>@(IsRecording ? "Recording..." : "Start Recording")</span>
                    </button>

                    <!-- Stop Recording -->
                    <button class="action-btn action-btn-gray" 
                            @onclick="StopRecording" 
                            disabled="@(!IsRecording)">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 9h4v6h-4V9z" />
                        </svg>
                        <span>Stop Recording</span>
                    </button>

                    <!-- Save Video (only visible after recording stops) -->
                    @if (HasRecordedVideo)
                    {
                        <button class="action-btn action-btn-green" @onclick="SaveVideo">
                            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            <span>Save Video</span>
                        </button>
                    }
                </div>

                <!-- Info Bar - Record Mode -->
                <div class="info-bar">
                    <span>Resolution: @RecordResolution</span>
                    <span>Length: @RecordingLength</span>
                    <span class="@(IsRecording ? "status-recording" : "status-ready")">
                        Status: @(IsRecording ? "Recording" : "Ready")
                    </span>
                </div>
            }
        </div>
    </div>
</div>

@* Lightbox Modal - Image Viewer *@
@if (IsLightboxOpen && !string.IsNullOrEmpty(CurrentScreenshot.ImageBase64))
{
    <div class="lightbox-overlay" @onclick="CloseLightbox">
        <div class="lightbox-container" @onclick:stopPropagation="true">
            <!-- Close Button -->
            <button class="lightbox-close" @onclick="CloseLightbox" title="Close (ESC)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <!-- Image -->
            <div class="lightbox-image-wrapper">
                <img src="data:image/@CurrentScreenshot.Format;base64,@CurrentScreenshot.ImageBase64"
                     alt="Screenshot Preview"
                     class="lightbox-image"
                     style="transform: scale(@LightboxZoom.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)) rotate(@(LightboxRotate)deg);" />
            </div>

            <!-- Toolbar -->
            <div class="lightbox-toolbar">
                <button class="lightbox-btn" @onclick="LightboxZoomIn" title="Zoom In">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6" />
                    </svg>
                </button>
                <button class="lightbox-btn" @onclick="LightboxZoomOut" title="Zoom Out">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
                    </svg>
                </button>
                <div class="lightbox-divider"></div>
                <button class="lightbox-btn" @onclick="LightboxRotateLeft" title="Rotate Left">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                    </svg>
                </button>
                <button class="lightbox-btn" @onclick="LightboxRotateRight" title="Rotate Right">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6" />
                    </svg>
                </button>
                <div class="lightbox-divider"></div>
                <span class="lightbox-zoom-label">@((LightboxZoom * 100).ToString("F0"))%</span>
            </div>
        </div>
    </div>
}

@code {
    private enum ScreenMode
    {
        Capture,
        Stream,
        Record
    }

    // CascadingParameter from DeviceControl
    [CascadingParameter(Name = "AgentId")]
    public string AgentId { get; set; } = string.Empty;

    // SignalR
    private HubConnection? _hubConnection;
    private bool IsConnected => _hubConnection?.State == HubConnectionState.Connected;

    // Timer to refresh info bar (for "Last capture" display)
    private System.Timers.Timer? _infoRefreshTimer;

    // Screenshot result
    private ScreenshotResult CurrentScreenshot { get; set; } = new()
    {
        ImageBase64 = "",
        Width = 1920,
        Height = 1080,
        Format = "jpeg",
        CapturedAt = DateTime.Now.AddMinutes(-2)
    };

    private string CaptureStatus { get; set; } = "Ready";
    private bool IsCapturing { get; set; } = false;

    private ScreenMode CurrentMode { get; set; } = ScreenMode.Capture;

    private bool IsStreaming { get; set; } = false;
    private string StreamResolution { get; set; } = "1920×1080";
    private string StreamFPS { get; set; } = "30";
    private string StreamBitrate { get; set; } = "4500 kbps";

    private bool IsRecording { get; set; } = false;
    private bool HasRecordedVideo { get; set; } = false;
    private string RecordResolution { get; set; } = "1920×1080";
    private string RecordingLength { get; set; } = "00:00:00";
    private System.Timers.Timer? _recordingTimer;
    private TimeSpan _recordingElapsed = TimeSpan.Zero;
    private bool RecordingPulse { get; set; } = false;
    private System.Timers.Timer? _pulseTimer;

    // Lightbox state
    private bool IsLightboxOpen { get; set; } = false;
    private double LightboxZoom { get; set; } = 1.0;
    private int LightboxRotate { get; set; } = 0;

    // Helper: Format resolution from model
    private string GetResolutionDisplay() => $"{CurrentScreenshot.Width}×{CurrentScreenshot.Height}";

    // Helper: Format last capture time in friendly way
    private string GetLastCaptureDisplay()
    {
        var captureTime = CurrentScreenshot.CapturedAt;
        if (captureTime == default) return "Never";
        
        var elapsed = DateTime.UtcNow - captureTime;
        
        if (elapsed.TotalSeconds < 30) return "Just now";
        if (elapsed.TotalMinutes < 1) return "Less than 1 min ago";
        if (elapsed.TotalMinutes < 60) return $"{(int)elapsed.TotalMinutes} min ago";
        if (elapsed.TotalHours < 24) return $"{(int)elapsed.TotalHours} hr ago";
        return captureTime.ToLocalTime().ToString("MMM dd, HH:mm");
    }

    // Helper: Status color class
    private string GetStatusClass()
    {
        return CaptureStatus switch
        {
            "Ready" => "status-ready",
            "Capturing..." => "status-capturing",
            "Error" => "status-error",
            _ => ""
        };
    }

    protected override async Task OnInitializedAsync()
    {
        await InitializeSignalR();

        // Auto-refresh info bar every 30 seconds to update "Last capture" display
        _infoRefreshTimer = new System.Timers.Timer(30000);
        _infoRefreshTimer.Elapsed += (s, e) => InvokeAsync(StateHasChanged);
        _infoRefreshTimer.Start();
    }

    private async void SwitchMode(ScreenMode mode)
    {
        // Stop any active operations when switching modes
        if (IsStreaming)
        {
            await StopStream();
        }
        if (IsRecording)
        {
            StopRecording();
        }

        CurrentMode = mode;
        StateHasChanged();
    }

    private async Task StartStream()
    {
        if (_hubConnection == null || !IsConnected) return;
        if (string.IsNullOrEmpty(AgentId)) return;

        IsStreaming = true;
        _frameCount = 0;
        _fpsStopwatch = System.Diagnostics.Stopwatch.StartNew();
        
        // Tell agent to start streaming
        await _hubConnection.InvokeAsync(HubEvents.StartScreenStream, AgentId, 10, 70);
        Console.WriteLine("[RemoteScreen] Stream started");
        StateHasChanged();
    }

    private async Task StopStream()
    {
        if (_hubConnection == null || !IsConnected) return;
        
        IsStreaming = false;
        StreamFPS = "0";
        
        // Tell agent to stop streaming
        await _hubConnection.InvokeAsync(HubEvents.StopScreenStream, AgentId);
        Console.WriteLine("[RemoteScreen] Stream stopped");
        StateHasChanged();
    }

    // Frame counter for FPS calculation
    private int _frameCount = 0;
    private System.Diagnostics.Stopwatch? _fpsStopwatch;

    private void OnScreenFrameReceived(string agentId, ScreenshotResult frame)
    {
        if (agentId != AgentId) return;
        if (!IsStreaming) return;

        // Update current screenshot
        CurrentScreenshot = frame;
        StreamResolution = $"{frame.Width}×{frame.Height}";
        
        // Calculate FPS
        _frameCount++;
        if (_fpsStopwatch != null && _fpsStopwatch.ElapsedMilliseconds >= 1000)
        {
            StreamFPS = _frameCount.ToString();
            _frameCount = 0;
            _fpsStopwatch.Restart();
        }

        InvokeAsync(StateHasChanged);
    }

    private void StartRecording()
    {
        IsRecording = true;
        HasRecordedVideo = false;
        _recordingElapsed = TimeSpan.Zero;
        RecordingLength = "00:00:00";

        // Start recording timer
        _recordingTimer = new System.Timers.Timer(1000);
        _recordingTimer.Elapsed += (s, e) =>
        {
            _recordingElapsed = _recordingElapsed.Add(TimeSpan.FromSeconds(1));
            RecordingLength = _recordingElapsed.ToString(@"hh\:mm\:ss");
            InvokeAsync(StateHasChanged);
        };
        _recordingTimer.Start();

        // Start pulse animation
        _pulseTimer = new System.Timers.Timer(500);
        _pulseTimer.Elapsed += (s, e) =>
        {
            RecordingPulse = !RecordingPulse;
            InvokeAsync(StateHasChanged);
        };
        _pulseTimer.Start();

        Console.WriteLine("[RemoteScreen] Recording started");
        StateHasChanged();
    }

    private void StopRecording()
    {
        IsRecording = false;
        HasRecordedVideo = true;
        
        _recordingTimer?.Stop();
        _recordingTimer?.Dispose();
        _recordingTimer = null;

        _pulseTimer?.Stop();
        _pulseTimer?.Dispose();
        _pulseTimer = null;
        RecordingPulse = false;

        Console.WriteLine($"[RemoteScreen] Recording stopped. Length: {RecordingLength}");
        StateHasChanged();
    }

    private async Task SaveVideo()
    {
        var fileName = $"recording_{DateTime.Now:yyyyMMdd_HHmmss}.mp4";
        Console.WriteLine($"[RemoteScreen] Saving video: {fileName}");
        
        // TODO: Implement actual video save logic
        await Task.CompletedTask;
    }

    // Action methods
    private async Task CaptureScreen()
    {
        if (_hubConnection == null || !IsConnected) 
        {
            Console.WriteLine("[RemoteScreen] Not connected to SignalR");
            return;
        }
        if (string.IsNullOrEmpty(AgentId)) 
        {
            Console.WriteLine("[RemoteScreen] AgentId is empty");
            return;
        }

        CaptureStatus = "Capturing...";
        IsCapturing = true;
        StateHasChanged();

        var request = CommandRequest.CreateCaptureScreen(AgentId);
        await _hubConnection.InvokeAsync("SendCommand", request);
        Console.WriteLine($"[RemoteScreen] Capture screen requested for {AgentId}");
    }

    private async Task SaveToDevice()
    {
        if (string.IsNullOrEmpty(CurrentScreenshot.ImageBase64))
        {
            Console.WriteLine("[RemoteScreen] No screenshot to save");
            return;
        }

        var fileName = $"screenshot_{DateTime.Now:yyyyMMdd_HHmmss}.{CurrentScreenshot.Format}";
        var dataUrl = $"data:image/{CurrentScreenshot.Format};base64,{CurrentScreenshot.ImageBase64}";
        
        await JSRuntime.InvokeVoidAsync("downloadImage", fileName, dataUrl);
        Console.WriteLine($"[RemoteScreen] Saved: {fileName}");
    }

    private async Task CopyImage()
    {
        if (string.IsNullOrEmpty(CurrentScreenshot.ImageBase64))
        {
            Console.WriteLine("[RemoteScreen] No screenshot to copy");
            return;
        }

        var dataUrl = $"data:image/{CurrentScreenshot.Format};base64,{CurrentScreenshot.ImageBase64}";
        await JSRuntime.InvokeVoidAsync("copyImageToClipboard", dataUrl);
        Console.WriteLine("[RemoteScreen] Image copied to clipboard");
    }

    // Lightbox methods
    private void OpenLightbox()
    {
        if (string.IsNullOrEmpty(CurrentScreenshot.ImageBase64)) return;
        IsLightboxOpen = true;
        LightboxZoom = 1.0;
        LightboxRotate = 0;
    }

    private void CloseLightbox()
    {
        IsLightboxOpen = false;
    }

    private void LightboxZoomIn()
    {
        LightboxZoom = Math.Min(LightboxZoom + 0.25, 4.0);
    }

    private void LightboxZoomOut()
    {
        LightboxZoom = Math.Max(LightboxZoom - 0.25, 0.25);
    }

    private void LightboxRotateLeft()
    {
        LightboxRotate = (LightboxRotate - 90) % 360;
    }

    private void LightboxRotateRight()
    {
        LightboxRotate = (LightboxRotate + 90) % 360;
    }

    private async Task InitializeSignalR()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri("/remotehub"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<CommandResult>(HubEvents.CommandCompleted, OnCommandCompleted);
        
        // Handle streaming frames
        _hubConnection.On<string, ScreenshotResult>(HubEvents.ScreenFrameReceived, OnScreenFrameReceived);

        try
        {
            await _hubConnection.StartAsync();
            Console.WriteLine("[RemoteScreen] SignalR connected");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[RemoteScreen] SignalR error: {ex.Message}");
        }
    }

    private void OnCommandCompleted(CommandResult result)
    {
        if (result.AgentId != AgentId) return;
        
        if (!result.Success) 
        {
            CaptureStatus = "Error";
            IsCapturing = false;
            InvokeAsync(StateHasChanged);
            return;
        }

        // ScreenshotResult is stored in CommandResult.Data
        if (result.Data is System.Text.Json.JsonElement jsonElement)
        {
            try
            {
                var screenshotResult = System.Text.Json.JsonSerializer.Deserialize<ScreenshotResult>(
                    jsonElement.GetRawText(),
                    new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                
                if (screenshotResult != null && !string.IsNullOrEmpty(screenshotResult.ImageBase64))
                {
                    CurrentScreenshot = screenshotResult;
                    CaptureStatus = "Ready";
                    IsCapturing = false;
                    Console.WriteLine($"[RemoteScreen] Received screenshot: {screenshotResult.Width}x{screenshotResult.Height}");
                    InvokeAsync(StateHasChanged);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[RemoteScreen] Parse error: {ex.Message}");
                CaptureStatus = "Error";
                IsCapturing = false;
                InvokeAsync(StateHasChanged);
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        _infoRefreshTimer?.Stop();
        _infoRefreshTimer?.Dispose();
        
        _recordingTimer?.Stop();
        _recordingTimer?.Dispose();
        
        _pulseTimer?.Stop();
        _pulseTimer?.Dispose();

        if (_hubConnection != null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}

<style>
    /* Base Styles */
    .remote-screen-tab {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem;
        gap: 1rem;
    }

    .screen-container-wrapper {
        width: 100%;
        max-width: 56rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    /* Screen Container */
    .screen-container {
        width: 100%;
        aspect-ratio: 16/9;
        background-color: #0f172a;
        border-radius: 0.75rem;
        border: 1px solid var(--card-border);
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }

    .screen-display {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #000;
    }

    .screen-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .no-capture-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        color: rgba(255, 255, 255, 0.4);
        text-align: center;
        padding: 2rem;
    }

    .placeholder-icon {
        width: 4rem;
        height: 4rem;
        stroke-width: 1.5;
    }

    /* Mode Switcher - Segmented Control */
    .mode-switcher-container {
        width: 100%;
        display: flex;
        justify-content: center;
        padding: 0.5rem 0;
    }

    .mode-switcher {
        display: flex;
        background-color: #1e293b;
        border-radius: 9999px;
        padding: 0.25rem;
        gap: 0.25rem;
        border: 1px solid #334155;
    }

    .mode-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1.25rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
        color: #94a3b8;
        background-color: transparent;
    }

    .mode-btn:hover {
        color: #cbd5e1;
    }

    .mode-btn.active {
        background-color: #3b82f6;
        color: white;
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4);
    }

    .mode-icon {
        width: 1rem;
        height: 1rem;
    }

    /* Action Toolbar */
    .action-toolbar-container {
        width: 100%;
        max-width: 56rem;
    }

    .action-toolbar {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        padding: 1rem;
        background-color: var(--table-bg);
        border-radius: 0.5rem;
        border: 1px solid var(--card-border);
    }

    /* Action Buttons */
    .action-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
        color: white;
        position: relative;
    }

    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .action-btn:not(:disabled):hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        transform: scale(1.05);
    }

    .action-btn:not(:disabled):active {
        transform: scale(0.95);
    }

    .action-btn-blue {
        background-color: #2563eb;
    }

    .action-btn-blue:not(:disabled):hover {
        background-color: #1d4ed8;
    }

    .action-btn-green {
        background-color: #16a34a;
    }

    .action-btn-green:not(:disabled):hover {
        background-color: #15803d;
    }

    .action-btn-purple {
        background-color: #9333ea;
    }

    .action-btn-purple:not(:disabled):hover {
        background-color: #7e22ce;
    }

    .action-btn-red {
        background-color: #dc2626;
    }

    .action-btn-red:not(:disabled):hover {
        background-color: #b91c1c;
    }

    .action-btn-gray {
        background-color: #475569;
    }

    .action-btn-gray:not(:disabled):hover {
        background-color: #334155;
    }

    .btn-icon {
        width: 1rem;
        height: 1rem;
    }

    /* Recording indicator pulse animation */
    .recording-indicator {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        width: 0.5rem;
        height: 0.5rem;
        background-color: #ef4444;
        border-radius: 50%;
        animation: pulse 1s infinite;
    }

    @@keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.3;
        }
    }

    /* Info Bar */
    .info-bar {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        padding: 0.75rem 1.5rem;
        background-color: rgba(30, 41, 59, 0.5);
        border-radius: 0.5rem;
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: #cbd5e1;
    }

    .info-bar > span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .status-ready {
        color: #10b981;
    }

    .status-capturing {
        color: #3b82f6;
    }

    .status-streaming {
        color: #3b82f6;
        animation: pulse 2s infinite;
    }

    .status-recording {
        color: #ef4444;
        animation: pulse 2s infinite;
    }

    .status-error {
        color: #ef4444;
    }

    /* Lightbox Modal */
    .lightbox-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeIn 0.2s;
    }

    .lightbox-container {
        position: relative;
        width: 90vw;
        height: 90vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .lightbox-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 3rem;
        height: 3rem;
        border-radius: 9999px;
        background-color: rgba(30, 30, 30, 0.9);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        z-index: 10001;
    }

    .lightbox-close:hover {
        background-color: rgba(239, 68, 68, 0.9);
        transform: scale(1.1);
    }

    .lightbox-close svg {
        width: 1.5rem;
        height: 1.5rem;
    }

    .lightbox-image-wrapper {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .lightbox-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        transition: transform 0.2s;
    }

    .lightbox-toolbar {
        position: absolute;
        bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background-color: rgba(30, 30, 30, 0.9);
        backdrop-filter: blur(8px);
        padding: 0.75rem 1.25rem;
        border-radius: 9999px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
    }

    .lightbox-btn {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 9999px;
        background-color: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .lightbox-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
    }

    .lightbox-btn:active {
        transform: scale(0.95);
    }

    .lightbox-btn svg {
        width: 1.25rem;
        height: 1.25rem;
    }

    .lightbox-divider {
        width: 1px;
        height: 1.5rem;
        background-color: rgba(255, 255, 255, 0.2);
        margin: 0 0.25rem;
    }

    .lightbox-zoom-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.875rem;
        font-weight: 500;
        min-width: 3rem;
        text-align: center;
    }

    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
</style>
