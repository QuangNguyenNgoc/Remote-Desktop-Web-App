@page "/"

@using Microsoft.AspNetCore.SignalR.Client
@using RemoteControl.Shared.Models
@using RemoteControl.Shared.Constants
@using RemoteControl.Web.Services
@using System.Text.Json
@using System.Globalization
@using System.Text
@using Microsoft.JSInterop

@implements IAsyncDisposable
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject DashboardStateService DashboardState

@* ┌─────────────────────────────────────────────────────────────┐
   │  📊 Dashboard (Figma-like charts)                           │
   └─────────────────────────────────────────────────────────────┘ *@

@* [A] 4 STAT CARDS (real-time) *@
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <StatCard Title="Total" Value="@TotalAgents.ToString()" SubText="Total agents seen"
              ColorClass="bg-blue-500/10 text-blue-500">
        <Icon>
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
        </Icon>
        <SubContent>
            <p class="text-xs mt-2" style="color: var(--text-quaternary);">Last sync: @_lastSyncText</p>
        </SubContent>
    </StatCard>

    <StatCard Title="Online" Value="@OnlineAgents.ToString()" SubText="Agents currently online"
              ColorClass="bg-green-500/10 text-green-500">
        <Icon>
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 12l2 2 4-4M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10z" />
            </svg>
        </Icon>
    </StatCard>

    <StatCard Title="Offline" Value="@OfflineAgents.ToString()" SubText="Total - Online"
              ColorClass="bg-yellow-500/10 text-yellow-500">
        <Icon>
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M18.364 5.636l-12.728 12.728M6.343 6.343a8 8 0 0111.314 11.314A8 8 0 016.343 6.343z" />
            </svg>
        </Icon>
    </StatCard>

    <StatCard Title="Commands" Value="@_commandsThisSession.ToString()" SubText="Completed in this session"
              ColorClass="bg-purple-500/10 text-purple-500">
        <Icon>
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M8 9l3 3-3 3m5 0h3M4 4h16v16H4V4z" />
            </svg>
        </Icon>
        <SubContent>
            <p class="text-xs mt-2" style="color: var(--text-quaternary);">Uptime: @_uptimeCompact</p>
        </SubContent>
    </StatCard>
</div>

@* [B] CHARTS (Figma-like) - ✅ Chart.js *@
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">

    @* (1) Agents over Time (24h) *@
    <div class="rounded-2xl p-6 overflow-hidden"
         style="background-color: var(--card-bg); border: 1px solid var(--card-border); box-shadow: 0 8px 18px rgba(0,0,0,0.04);">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-lg" style="color: var(--text-primary);">Agents over Time (24h)</h3>
        </div>

        <div class="relative rounded-2xl p-4 overflow-hidden"
             style="background-color: var(--table-bg); border: 1px solid var(--table-border); height: 280px;">
            <div style="height: 250px;">
                <canvas id="agentsLineChart"></canvas>
            </div>
        </div>
    </div>

    @* (2) Commands Frequency (Bar) *@
    <div class="rounded-2xl p-6 overflow-hidden"
         style="background-color: var(--card-bg); border: 1px solid var(--card-border); box-shadow: 0 8px 18px rgba(0,0,0,0.04);">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-lg" style="color: var(--text-primary);">Commands Frequency</h3>
            <span class="text-xs" style="color: var(--text-quaternary);">Session: @_commandsThisSession</span>
        </div>

        <div class="relative rounded-2xl p-4 overflow-hidden"
             style="background-color: var(--table-bg); border: 1px solid var(--table-border); height: 280px;">
            <div style="height: 250px;">
                <canvas id="commandsBarChart"></canvas>
            </div>
        </div>
    </div>
</div>

@* --- Main Layout --- *@
<div class="grid grid-cols-1 xl:grid-cols-3 gap-6">

    @* Recent Activity *@
    <div class="xl:col-span-2 rounded-xl flex flex-col h-full"
         style="background-color: var(--card-bg); border: 1px solid var(--card-border); overflow: visible;">

        <div class="px-6 py-4 flex items-center justify-between gap-4"
             style="border-bottom: 1px solid var(--card-border);">
            <div class="flex items-center gap-3">
                <h3 class="font-semibold text-lg" style="color: var(--text-primary);">Recent Activity</h3>

                <div class="flex items-center gap-2 text-sm">
                    @foreach (var f in _activityFilters)
                    {
                        var active = _activityFilter == f;
                        <button class="px-3 py-1 rounded-full transition-colors"
                                style="
                                    border: 1px solid var(--card-border);
                                    background-color: @(active ? "rgba(37, 99, 235, 0.12)" : "transparent");
                                    color: @(active ? "var(--text-primary)" : "var(--text-secondary)");
                                "
                                @onclick="() => SetFilter(f)">
                            @f
                        </button>
                    }
                </div>
            </div>

            <button class="text-sm transition-colors"
                    style="color: var(--btn-primary-bg);"
                    onmouseover="this.style.color='var(--btn-primary-hover)';"
                    onmouseout="this.style.color='var(--btn-primary-bg)';">
                View All Logs
            </button>
        </div>

        <div class="grow" style="overflow: visible;">
            @* Header row *@
            <div class="grid grid-cols-4 gap-4 px-6 py-3 uppercase text-xs font-semibold"
                 style="background-color: var(--table-header-bg); color: var(--table-header-text);">
                <div>Agent</div>
                <div>Type</div>
                <div>Details</div>
                <div>Time</div>
            </div>

            @* Activity rows *@
            <div style="border-top: 1px solid var(--table-border);">
                @if (FilteredActivities.Count == 0)
                {
                    <div class="px-6 py-6" style="color: var(--text-secondary); border-bottom: 1px solid var(--table-border);">
                        No activities for filter:
                        <span class="font-semibold" style="color: var(--text-primary);">@_activityFilter</span>
                    </div>
                }
                else
                {
                    @foreach (var activity in FilteredActivities)
                    {
                        <div class="relative"
                             @onmouseenter="() => _hoveredActivity = activity"
                             @onmouseleave="() => _hoveredActivity = null">
                            
                            @* Row content *@
                            <div class="grid grid-cols-4 gap-4 px-6 py-4 text-sm transition-colors cursor-pointer"
                                 style="border-bottom: 1px solid var(--table-border); color: var(--table-text);"
                                 onmouseover="this.style.backgroundColor='var(--table-row-hover)';"
                                 onmouseout="this.style.backgroundColor='transparent';">
                                <div class="font-medium" style="color: var(--table-text-primary);">@activity.AgentId</div>
                                <div>
                                    <span class="px-2 py-1 rounded text-xs"
                                          style="background-color: @activity.BadgeBgColor; color: @activity.BadgeTextColor;">
                                        @activity.EventType
                                    </span>
                                </div>
                                <div class="truncate">@activity.Summary</div>
                                <div>@activity.TimeText</div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    @* Right column - Activity Detail Panel *@
    <div class="xl:col-span-1 h-full space-y-6">

        @* Activity Detail - Shows when hovering a row *@
        @if (_hoveredActivity is not null)
        {
            <div class="rounded-2xl p-5 hover-card-fade-in"
                 style="background-color: var(--card-bg); border: 2px solid #14b8a6; box-shadow: 0 8px 18px rgba(0,0,0,0.08);">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold text-base" style="color: var(--text-primary);">Activity Detail</h3>
                    <span class="px-2 py-0.5 rounded text-xs"
                          style="background-color: @_hoveredActivity.BadgeBgColor; color: @_hoveredActivity.BadgeTextColor;">
                        @_hoveredActivity.EventType
                    </span>
                </div>

                <div class="space-y-3">
                    <div>
                        <div class="text-xs mb-1" style="color: var(--text-tertiary);">Agent</div>
                        <div class="text-sm font-medium" style="color: var(--text-primary);">@_hoveredActivity.AgentId</div>
                    </div>
                    <div>
                        <div class="text-xs mb-1" style="color: var(--text-tertiary);">Time</div>
                        <div class="text-sm" style="color: var(--text-secondary);">@_hoveredActivity.TimeText</div>
                    </div>
                    <div>
                        <div class="text-xs mb-1" style="color: var(--text-tertiary);">Summary</div>
                        <div class="text-sm" style="color: var(--text-secondary);">@_hoveredActivity.Summary</div>
                    </div>
                    <div>
                        <div class="text-xs mb-1" style="color: var(--text-tertiary);">Full Details</div>
                        <div class="rounded-lg p-3 text-xs whitespace-pre-wrap"
                             style="background-color: var(--table-header-bg); border: 1px solid var(--table-border); color: var(--text-primary);">
                            @_hoveredActivity.Details
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            @* Agent Map placeholder - Shows when not hovering *@
            <div class="rounded-2xl p-6"
                 style="background-color: var(--card-bg); border: 1px solid var(--card-border); box-shadow: 0 8px 18px rgba(0,0,0,0.04);">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold text-lg" style="color: var(--text-primary);">Agent Map (Optional)</h3>
                    <span class="text-xs" style="color: var(--text-quaternary);">Advanced</span>
                </div>

                <div class="rounded-2xl p-4 h-48 flex items-center justify-center text-center"
                     style="
                        background:
                            radial-gradient(circle at 20% 30%, rgba(37,99,235,0.12) 0%, transparent 45%),
                            radial-gradient(circle at 70% 60%, rgba(16,185,129,0.10) 0%, transparent 45%),
                            var(--table-header-bg);
                        border: 1px dashed rgba(148,163,184,0.55);
                     ">
                    <div class="text-sm" style="color: var(--text-secondary);">
                        Hover một activity để xem chi tiết<br />
                        <span class="text-xs" style="color: var(--text-quaternary);">
                            (Chi tiết sẽ hiện ở đây)
                        </span>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    // ============================
    // State from DashboardStateService
    // (persists across navigation)
    // ============================

    private int TotalAgents => DashboardState.TotalAgents;
    private int OnlineAgents => DashboardState.OnlineAgents;
    private int OfflineAgents => DashboardState.OfflineAgents;
    private int _commandsThisSession => DashboardState.CommandsThisSession;
    private List<AgentActivityModel> RecentActivities => DashboardState.RecentActivities;

    // ============================
    // Local UI state (component-specific)
    // ============================

    private string _uptimeCompact = "0s";
    private System.Threading.Timer? _uptimeTimer;
    private string _lastSyncText = "—";

    private readonly List<string> _activityFilters = new() { "All", "Connect", "Disconnect", "Command" };
    private string _activityFilter = "All";

    private List<AgentActivityModel> FilteredActivities =>
        (_activityFilter == "All"
            ? RecentActivities
            : RecentActivities.Where(a => a.FilterKey == _activityFilter))
        .Take(10).ToList();

    // Hover state for Activity detail panel (Right column)
    private AgentActivityModel? _hoveredActivity = null;

    private void SetFilter(string f) => _activityFilter = f;

    // ============================
    // JS interop for charts
    // ============================

    private IJSObjectReference? _chartsModule;
    private bool _chartsPendingUpdate = true; // page load => render once
    private bool _chartsInitialized = false;
    private System.Threading.Timer? _chartTimer;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // import ES module from wwwroot
            _chartsModule = await JS.InvokeAsync<IJSObjectReference>("import", "./js/dashboardCharts.js");
            _chartsInitialized = true;

            // first paint
            await UpdateChartsAsync();
            _chartsPendingUpdate = false;
        }
        else if (_chartsInitialized && _chartsPendingUpdate)
        {
            _chartsPendingUpdate = false;
            await UpdateChartsAsync();
        }
    }

    private void QueueChartsUpdate()
    {
        _chartsPendingUpdate = true;

        // nếu module đã sẵn => update ngay trên UI thread
        if (_chartsInitialized)
        {
            _ = InvokeAsync(async () =>
            {
                await UpdateChartsAsync();
                StateHasChanged();
            });
        }
    }

    private async Task UpdateChartsAsync()
    {
        if (_chartsModule is null) return;

        BuildAgents24hSeries(out var timeLabels, out var agentsValues);
        BuildCommandsSeries(out var cmdLabels, out var cmdValues);

        await _chartsModule.InvokeVoidAsync("createOrUpdateAgentsLine", "agentsLineChart", timeLabels, agentsValues);
        await _chartsModule.InvokeVoidAsync("createOrUpdateCommandsBar", "commandsBarChart", cmdLabels, cmdValues);
    }

    private void BuildAgents24hSeries(out List<string> labels, out List<int> values)
    {
        // 24h, step 2h => 13 điểm (giống cảm giác figma)
        var end = DateTime.UtcNow;
        var start = end.AddHours(-24);

        labels = new List<string>(13);
        values = new List<int>(13);

        var series = DashboardState.OnlineSeries;
        int j = 0;
        int lastKnown = series.Count > 0 ? series[0].online : OnlineAgents;

        for (int i = 0; i <= 12; i++)
        {
            var t = start.AddHours(2 * i);

            while (j < series.Count && series[j].tUtc <= t)
            {
                lastKnown = series[j].online;
                j++;
            }

            labels.Add(t.ToLocalTime().ToString("HH:mm"));
            values.Add(lastKnown);
        }
    }

    private void BuildCommandsSeries(out List<string> labels, out List<int> values)
    {
        (labels, values) = DashboardState.GetCommandCountsData();
    }

    // ============================
    // Init
    // ============================

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to state changes from the service for auto UI updates
        DashboardState.OnStateChanged += HandleStateChanged;
        
        // Initialize the shared service (only connects if not already connected)
        try
        {
            await DashboardState.InitializeAsync(NavigationManager.ToAbsoluteUri("/remotehub").ToString());
            SyncTick();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Home] DashboardState init error: {ex.Message}");
        }

        // Uptime timer - component-specific
        _uptimeTimer = new System.Threading.Timer(_ =>
        {
            UpdateUptimeText();
            InvokeAsync(StateHasChanged);
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));

        // Chart refresh timer
        _chartTimer = new System.Threading.Timer(_ =>
        {
            DashboardState.AddOnlinePoint();
            QueueChartsUpdate();
            InvokeAsync(StateHasChanged);
        }, null, TimeSpan.FromSeconds(10), TimeSpan.FromSeconds(60));
    }

    private void HandleStateChanged()
    {
        QueueChartsUpdate();
        SyncTick();
    }

    private void SyncTick()
    {
        _lastSyncText = DashboardState.LastSyncUtc.ToLocalTime().ToString("HH:mm:ss");
        InvokeAsync(StateHasChanged);
    }

    private void UpdateUptimeText()
    {
        var uptime = DateTime.UtcNow - DashboardState.AppStartUtc;
        if (uptime.TotalDays >= 1) _uptimeCompact = $"{(int)uptime.TotalDays}d {(int)uptime.Hours}h";
        else if (uptime.TotalHours >= 1) _uptimeCompact = $"{(int)uptime.TotalHours}h {(int)uptime.Minutes}m";
        else if (uptime.TotalMinutes >= 1) _uptimeCompact = $"{(int)uptime.TotalMinutes}m {(int)uptime.Seconds}s";
        else _uptimeCompact = $"{(int)uptime.TotalSeconds}s";
    }

    // ============================
    // Helpers
    // ============================

    private static bool HasPropIgnoreCase(JsonElement obj, string name)
    {
        if (obj.ValueKind != JsonValueKind.Object) return false;
        foreach (var p in obj.EnumerateObject())
        {
            if (string.Equals(p.Name, name, StringComparison.OrdinalIgnoreCase))
                return true;
        }
        return false;
    }

    private string ClassifyCommand(CommandResult r)
    {
        if (r.Data is ScreenshotResult) return "Capture";
        if (r.Data is ProcessListResult) return "Process";
        if (r.Data is KeylogResult) return "Keylog";
        if (r.Data is RegistryResult) return "Registry";

        if (r.Data is JsonElement je)
        {
            if (HasPropIgnoreCase(je, "imageBase64")) return "Capture";
            if (HasPropIgnoreCase(je, "processes")) return "Process";
            if (HasPropIgnoreCase(je, "entries")) return "Keylog";
            if (HasPropIgnoreCase(je, "keyPath")) return "Registry";
        }

        var msg = r.Message ?? "";
        if (msg.Contains("screenshot", StringComparison.OrdinalIgnoreCase) || msg.Contains("capture", StringComparison.OrdinalIgnoreCase)) return "Capture";
        if (msg.Contains("process", StringComparison.OrdinalIgnoreCase) || msg.Contains("ứng dụng", StringComparison.OrdinalIgnoreCase)) return "Process";
        if (msg.Contains("keylog", StringComparison.OrdinalIgnoreCase)) return "Keylog";
        if (msg.Contains("registry", StringComparison.OrdinalIgnoreCase)) return "Registry";

        return "Other";
    }

    public async ValueTask DisposeAsync()
    {
        _uptimeTimer?.Dispose();
        _uptimeTimer = null;

        _chartTimer?.Dispose();
        _chartTimer = null;

        // Unsubscribe from state changes
        DashboardState.OnStateChanged -= HandleStateChanged;

        // destroy charts
        if (_chartsModule is not null)
        {
            try
            {
                await _chartsModule.InvokeVoidAsync("destroyChart", "agentsLineChart");
                await _chartsModule.InvokeVoidAsync("destroyChart", "commandsBarChart");
                await _chartsModule.DisposeAsync();
            }
            catch { }
        }
    }
}

<style>
    /* Hover card fade-in animation */
    @@keyframes hoverCardFadeIn {
        from {
            opacity: 0;
            transform: translateY(-4px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .hover-card-fade-in {
        animation: hoverCardFadeIn 0.15s ease-out;
    }
</style>
