@page "/login"
@layout EmptyLayout
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager Nav
@inject HttpClient Http
@inject IJSRuntime JS

<div class="login-bg">
    <div class="login-frame">
        <div class="login-card">
            <div class="brand">
                <div class="brand-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 5h16a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2Z" />
                        <path d="M8 21h8" />
                        <path d="M12 18v3" />
                    </svg>
                </div>
                <div class="brand-text">Remote Control</div>
            </div>

            <div class="field">
                <label class="label" for="passkey">Enter Passkey</label>
                <input id="passkey"
                       class="input"
                       type="password"
                       autocomplete="current-password"
                       @bind="_passkey"
                       @bind:event="oninput"
                       @onkeydown="OnKeyDown"
                       disabled="@_isLoading" />
            </div>

            <div class="row">
                <label class="remember">
                    <input type="checkbox" @bind="_rememberMe" disabled="@_isLoading" />
                    <span>Remember me</span>
                    <span class="muted">(7 days)</span>
                </label>
            </div>

            @if (!string.IsNullOrWhiteSpace(_error))
            {
                <div class="error">@_error</div>
            }

            <button class="btn"
                    @onclick="LoginAsync"
                    disabled="@_isLoading">
                @if (_isLoading)
                {
                    <span class="spinner" aria-hidden="true"></span>
                    <span>LOGGING IN...</span>
                }
                else
                {
                    <span>LOGIN</span>
                }
            </button>
        </div>
    </div>

    @if (_toastVisible)
    {
        <div class="toast" role="status" aria-live="polite">
            @_toastMessage
        </div>
    }
</div>

@code {
    private sealed class VerifyResponse
    {
        public bool Success { get; set; }
    }

    private string _passkey = "";
    private bool _rememberMe = false;

    private bool _isLoading = false;
    private string _error = "";

    private bool _toastVisible = false;
    private string _toastMessage = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        // JS interop chỉ gọi an toàn sau khi render xong lần đầu
        if (await IsRememberedAndValidAsync())
        {
            Nav.NavigateTo("/devices", forceLoad: true);
        }
    }

    private async Task LoginAsync()
    {
        if (_isLoading) return;

        if (string.IsNullOrWhiteSpace(_passkey))
        {
            _error = "Please enter passkey.";
            await ShowToastAsync("Please enter passkey.");
            return;
        }

        _error = "";
        _isLoading = true;

        try
        {
            var resp = await Http.PostAsJsonAsync(Nav.ToAbsoluteUri("/api/auth/verify"), new { Passkey = _passkey });


            if (!resp.IsSuccessStatusCode)
            {
                _error = "Login failed. Please try again.";
                await ShowToastAsync("Login failed.");
                return;
            }

            var data = await resp.Content.ReadFromJsonAsync<VerifyResponse>();
            var ok = data?.Success == true;

            if (!ok)
            {
                _error = "Invalid passkey.";
                await ShowToastAsync("Invalid passkey.");
                return;
            }

            await PersistLoginAsync(_rememberMe);
            Nav.NavigateTo("/devices", forceLoad: true);
        }
        catch
        {
            _error = "Login failed. Please try again.";
            await ShowToastAsync("Login failed.");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            return LoginAsync();

        return Task.CompletedTask;
    }

    private async Task PersistLoginAsync(bool remember)
    {
        if (remember)
        {
            var until = DateTimeOffset.UtcNow.AddDays(7).ToUnixTimeSeconds().ToString();
            await JS.InvokeVoidAsync("localStorage.setItem", "rc_auth_until", until);
            await JS.InvokeVoidAsync("localStorage.setItem", "rc_auth", "1");
            await JS.InvokeVoidAsync("sessionStorage.removeItem", "rc_auth_session");
        }
        else
        {
            await JS.InvokeVoidAsync("sessionStorage.setItem", "rc_auth_session", "1");
            await JS.InvokeVoidAsync("localStorage.removeItem", "rc_auth_until");
            await JS.InvokeVoidAsync("localStorage.removeItem", "rc_auth");
        }
    }

    private async Task<bool> IsRememberedAndValidAsync()
    {
        var session = await JS.InvokeAsync<string>("sessionStorage.getItem", "rc_auth_session");
        if (session == "1") return true;

        var flag = await JS.InvokeAsync<string>("localStorage.getItem", "rc_auth");
        var untilStr = await JS.InvokeAsync<string>("localStorage.getItem", "rc_auth_until");
        if (flag != "1" || string.IsNullOrWhiteSpace(untilStr)) return false;

        if (!long.TryParse(untilStr, out var until)) return false;
        var now = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
        return now <= until;
    }

    private async Task ShowToastAsync(string message)
    {
        _toastMessage = message;
        _toastVisible = true;
        StateHasChanged();

        await Task.Delay(2500);

        _toastVisible = false;
        StateHasChanged();
    }
}


<style>
/* Bám wireframe: nền đơn giản + card giữa + viền (dashed frame) */
.login-bg{
    min-height:100vh;
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.08), rgba(2, 6, 23, 0.02));
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 24px;
}

.login-frame{
    width: 100%;
    max-width: 520px;
    border: 2px dashed rgba(148, 163, 184, 0.6);
    border-radius: 16px;
    padding: 28px;
    background: rgba(255,255,255,0.35);
    backdrop-filter: blur(6px);
}

.login-card{
    width: 100%;
    max-width: 360px;
    margin: 0 auto;
    display:flex;
    flex-direction:column;
    gap: 18px;
}

.brand{
    display:flex;
    align-items:center;
    justify-content:center;
    gap: 10px;
    margin-bottom: 6px;
}

.brand-icon{
    width: 26px;
    height: 26px;
    color: rgba(15, 23, 42, 0.75);
    display:flex;
    align-items:center;
    justify-content:center;
}

.brand-text{
    font-weight: 600;
    letter-spacing: .2px;
    color: rgba(15, 23, 42, 0.85);
}

.field{ display:flex; flex-direction:column; gap: 8px; }

.label{
    font-size: 14px;
    color: rgba(15, 23, 42, 0.75);
}

.input{
    width: 100%;
    border: 1px solid rgba(148, 163, 184, 0.8);
    border-radius: 10px;
    padding: 12px 14px;
    font-size: 14px;
    outline: none;
    background: rgba(255,255,255,0.75);
    box-sizing: border-box;
}

.input:focus{
    border-color: rgba(59, 130, 246, 0.9);
    box-shadow: 0 0 0 3px rgba(59,130,246,0.18);
}

.row{
    display:flex;
    align-items:center;
    justify-content:flex-start;
}

.remember{
    display:flex;
    align-items:center;
    gap: 10px;
    font-size: 14px;
    color: rgba(15, 23, 42, 0.8);
}

.muted{
    font-size: 12px;
    color: rgba(100, 116, 139, 0.9);
}

.error{
    border: 1px solid rgba(239, 68, 68, 0.35);
    background: rgba(239, 68, 68, 0.08);
    color: rgba(185, 28, 28, 0.95);
    border-radius: 10px;
    padding: 10px 12px;
    font-size: 13px;
}

.btn{
    width: 100%;
    border: 1px solid rgba(148, 163, 184, 0.8);
    background: rgba(255,255,255,0.75);
    border-radius: 10px;
    padding: 12px 14px;
    font-weight: 600;
    letter-spacing: .8px;
    cursor: pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    gap: 10px;
    transition: transform .06s ease, opacity .15s ease;
}

.btn:active:not(:disabled){ transform: scale(0.99); }
.btn:disabled{ opacity: .6; cursor:not-allowed; }

.spinner{
    width: 14px;
    height: 14px;
    border: 2px solid rgba(15,23,42,0.35);
    border-top-color: rgba(15,23,42,0.85);
    border-radius: 50%;
    animation: spin .7s linear infinite;
}

@@keyframes spin{ to { transform: rotate(360deg); } }

.toast{
    position: fixed;
    top: 18px;
    right: 18px;
    background: rgba(15, 23, 42, 0.92);
    color: white;
    padding: 10px 12px;
    border-radius: 10px;
    font-size: 13px;
    max-width: 280px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.18);
}
</style>
